<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Decision NAVigator — D-NAV Mini (v3.37)</title>
<style>
:root{--bg:#0b0f14;--card:#121821;--muted:#8fa1b7;--text:#e9eef5;--green:#3ecf8e;--red:#ff6b6b;--amber:#f3b431;--blue:#69a9ff;--ink:#cfe1ff}
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{background:var(--bg);color:var(--text);margin:0;padding:24px;overflow-x:hidden}
body.no-scroll{overflow:hidden}

/* Page banner */
.site-title{max-width:1200px;margin:0 auto 12px auto;padding:8px 2px;font-weight:900;letter-spacing:.2px}
.site-title h1{display:block;font-size:28px;font-weight:900;line-height:1;margin:0}
.site-title .sub{color:var(--muted);font-size:13px;margin-top:6px}

/* Layout */
.wrap{max-width:1200px;margin:0 auto;display:grid;gap:16px;grid-template-columns:1fr 1fr 1fr;align-items:stretch}
.wrap + .wrap{ margin-top:16px }
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);display:flex;flex-direction:column}
h1{margin:0 0 8px;font-weight:800;font-size:22px;letter-spacing:.2px}

/* Slider rows (global) */
.row{display:grid;grid-template-columns:180px 1fr 52px;gap:12px;align-items:center;margin:10px 0 12px}
.row:last-of-type{margin-bottom:8px}
.row label{font-weight:700;color:#d7e2ef;font-size:16px;display:flex;flex-direction:column;gap:4px}
.label-main{line-height:1}
.hint{font-weight:600;color:var(--muted);font-size:12px;line-height:1.2}
.scale-note{margin-top:8px;font-weight:900;color:#dbe8ff;font-size:15px}
input[type=range]{width:100%;height:32px}
output{text-align:right;display:inline-block;min-width:40px;font-weight:800;font-size:16px}
.muted{color:var(--muted);font-size:13px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

/* Aggressive window control */
.bar-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.badge-inline{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(105,169,255,.15);border:1px solid rgba(105,169,255,.35);font-size:11px;font-weight:800;color:#cfe1ff}

/* Stats */
.stats{display:grid;grid-template-rows:repeat(3,1fr);gap:12px}
.stat{background:rgba(255,255,255,.04);border-radius:12px;padding:14px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between}
.stat h3{margin:0;font-size:12px;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase}
.val{font-size:36px;font-weight:900;line-height:1.1}

/* pills — thinner */
.pill{
  display:inline-block;
  padding:1px 6px;
  border-radius:999px;
  font-weight:800;
  font-size:9px;
  line-height:1.1;
  white-space:nowrap;
}
.green{background:rgba(62,207,142,.18);color:var(--green);border:1px solid rgba(62,207,142,.4)}
.amber{background:rgba(243,180,49,.18);color:var(--amber);border:1px solid rgba(243,180,49,.35)}
.red{background:rgba(255,107,107,.18);color:var(--red);border:1px solid rgba(255,255,107,.4)}
.blue{background:rgba(105,169,255,.18);color:#beddff;border:1px solid rgba(105,169,255,.5)}

/* Summary */
.summary{display:grid;grid-template-rows:auto auto 1fr;gap:12px}
.arch h3,.comp h3,.coach h3{margin:0;font-size:12px;color:#9fb1c7;text-transform:uppercase;letter-spacing:.3px}
.arch .name{font-size:26px;font-weight:900;margin-top:6px}
.arch .desc{color:#c9d4e6;margin-top:6px}
.comp .big{font-size:44px;font-weight:900;margin-top:6px}
.comp .tag,.comp .breakdown{margin-top:4px;font-size:12px;color:#a7b4c7}
.coach .txt{margin-top:6px;color:#c9d4e6;line-height:1.55}

/* Inputs & Log */
.grid{display:grid;gap:12px}
.input{padding:10px;border:1px solid #333;border-radius:10px;background:#0f141b;color:var(--text)}
.btn{padding:12px 16px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn.secondary{background:#0f141b;border:1px solid #444}
.table-wrap{overflow:auto;border:1px solid #222;border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px}
thead{background:#0d0d0d;color:#fff}
tr+tr{border-top:1px solid #1e1e1e}

/* numeric alignment */
.num{text-align:right;font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1,"lnum" 1}
tbody tr:nth-child(even){background:rgba(255,255,255,.02)}

/* KPI Grid */
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
.kpi{background:rgba(255,255,255,.04);border-radius:12px;padding:12px 14px;position:relative}
.kpi h4{margin:0;font-size:12px;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase}
.kpi .big{font-size:28px;font-weight:900;margin-top:6px}
.mini{font-size:12px;color:#a7b4c7;margin-top:4px}

/* Distributions */
.stack{height:10px;border-radius:999px;background:rgba(255,255,255,.08);display:flex;overflow:hidden}
.seg{height:100%}
.g{background:rgba(62,207,142,.85)}
.a{background:rgba(243,180,49,.85)}
.r{background:rgba(255,107,107,.85)}
.dist-card{margin-top:14px}
.dist-card h3{margin:0 0 6px 0;font-size:14px}
.legend{display:flex;gap:12px;flex-wrap:wrap;color:#a7b4c7;font-size:12px;margin-top:6px}

/* Category list */
.alloc{margin-top:12px}
.alloc .row{display:grid;grid-template-columns:160px 1fr 260px;gap:12px;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.alloc .row:last-child{border-bottom:none}
.alloc .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
.alloc .bar>span{display:block;height:100%;background:var(--blue);transition:width .45s ease}
.alloc .meta{font-size:12px;color:#a7b4c7;text-align:right}

/* Footer links */
.footer-links{max-width:1200px;margin:20px auto 10px;text-align:left}
.footer-links a{font-size:18px;color:#cfe1ff;text-decoration:underline;text-underline-offset:4px;margin-right:22px;margin-left:0}

/* pulse */
@keyframes pulse-kpi{0%{box-shadow:0 0 0 0 rgba(105,169,255,.35)}100%{box-shadow:0 0 0 18px rgba(105,169,255,0)}}
.kpi.pulse{animation:pulse-kpi .6s ease}

/* ===== Compare modal: full-screen slide-over ===== */
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.0);z-index:9999;align-items:stretch;justify-content:flex-end;transition:background .28s ease}
.modal.show{display:flex;background:rgba(0,0,0,.6)}
.sheet{width:100vw;height:100vh;max-width:100vw;background:var(--card);box-shadow:0 20px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .32s ease}
.modal.show .sheet{transform:translateX(0)}
.sheet header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
.sheet header h2{margin:0;font-size:18px}
.sheet .body{padding:14px 16px;overflow:auto;flex:1;min-height:0}
.dual{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* Blue/Green accents */
.col-base{background:rgba(105,169,255,.06);border:1px solid rgba(105,169,255,.25);border-radius:12px}
.col-scenario{background:rgba(62,207,142,.06);border:1px solid rgba(62,207,142,.25);border-radius:12px}
.chip{display:inline-block;padding:3px 8px;border-radius:999px;font-size:10.5px;font-weight:900;letter-spacing:.3px;vertical-align:middle}
.chip.blue{background:rgba(105,169,255,.18);color:#beddff;border:1px solid rgba(105,169,255,.5)}
.chip.green{background:rgba(62,207,142,.18);color:#c8ffe6;border:1px solid rgba(62,207,142,.45)}

/* Winner & delta */
.win{font-weight:800;padding:6px 10px;border-radius:10px;font-size:12px}
.win.a{background:rgba(62,207,142,.18);color:var(--green);border:1px solid rgba(62,207,142,.4)}
.win.b{background:rgba(255,107,107,.18);color:var(--red);border:1px solid rgba(255,255,107,.4)}
.delta{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
.delta .tile{background:rgba(255,255,255,.04);border-radius:10px;padding:10px}
.delta .tile h4{margin:0 0 4px;font-size:11px;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase}
.delta .big{font-weight:900;font-size:20px}
.knob{margin-top:10px;font-size:13px;color:#cfe1ff}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.closeX{background:#222;border:1px solid #444;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
.cta{background:#0f62fe;border:0;color:#fff;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.helper{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;color:#c9d4e6;font-size:13px}

/* Floating Compare button */
.fab{position:fixed;right:18px;bottom:18px;background:#0f62fe;color:#fff;border:0;border-radius:999px;padding:14px 18px;font-weight:900;cursor:pointer;z-index:9998;box-shadow:0 12px 28px rgba(0,0,0,.45)}
.fab::after{content:'Compare';}
.fab.pulse{animation:pulse-kpi 1.2s ease infinite}

/* Inline Compare button */
.compare-inline{margin-top:8px}
.compare-inline .btn{background:#0f62fe}
.compare-inline .btn::after{content:'Open Compare';}

/* More… panel */
.more-panel{display:none;position:absolute;right:16px;top:58px;width:min(680px,92vw);max-height:55vh;overflow:auto;background:#0f141b;border:1px solid #2a3443;border-radius:12px;padding:10px;z-index:10000;box-shadow:0 12px 34px rgba(0,0,0,.6)}
.more-row{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
.more-row:hover{background:rgba(105,169,255,.08)}
.more-close{float:right;background:#222;border:1px solid #444;color:#fff;border-radius:10px;padding:6px 8px;cursor:pointer;margin-bottom:6px}

/* ===== Scenario rail (horizontal, tighter) ===== */
.scenarios{
  display:flex;
  gap:10px;
  margin-top:10px;
  overflow-x:auto;
  padding:4px 2px 6px;
  scroll-snap-type:x mandatory;
}
.scenarios::-webkit-scrollbar{height:8px}
.scenarios::-webkit-scrollbar-thumb{background:#2a3443;border-radius:999px}
.sc-card{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:10px;
  min-width:min(420px,92vw);
  scroll-snap-align:start;
  flex:0 0 auto;
}
.sc-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.sc-hue{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.sc-footer{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}

/* Make the rows inside scenario cards tighter without shrinking global rows */
.sc-card .row{grid-template-columns:140px 1fr 46px;margin:6px 0 8px;gap:10px}
.sc-card .row label{font-size:14px}
.sc-card .hint{font-size:11px}
.sc-card .kpis .kpi .big{font-size:24px}

/* === Delta Board (Base column visual) === */
.delta-board{margin-top:10px;background:rgba(255,255,255,.04);border-radius:10px;padding:8px}
.delta-board h4{margin:0 0 6px 0;font-size:11px;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase}
.delta-table{width:100%;border-collapse:collapse;font-size:12px}
.delta-table th,.delta-table td{padding:6px 6px;border-top:1px solid rgba(255,255,255,.06);text-align:right;font-variant-numeric:tabular-nums}
.delta-table th:first-child,.delta-table td:first-child{text-align:left}
.barchip{height:8px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;position:relative}
.barchip span{display:block;height:100%}
.barchip .pos{background:rgba(62,207,142,.9)}
.barchip .neg{background:rgba(255,107,107,.9)}
.arrow{font-weight:900}
.up{color:#3ecf8e}.down{color:#ff6b6b}.flat{color:#f3b431}

/* Mobile */
@media (max-width:900px){
  body{padding:14px}
  .site-title h0{font-size:24px}
  .wrap{grid-template-columns:1fr}
  .row{grid-template-columns:1fr 1fr 46px}
  h1{font-size:20px}
  .val{font-size:32px}
  .comp .big{font-size:38px}
  input[type=range]{height:36px}
  .kpis{grid-template-columns:1fr 1fr}
  .alloc .row{grid-template-columns:1fr}
  .alloc .meta{text-align:left}
  .dual{grid-template-columns:1fr}
  .fab{right:12px;bottom:12px}
  .more-panel{left:16px;right:16px;width:auto}
  .sheet{width:100vw}
}
</style>
</head>
<body>

<!-- Page banner -->
<div class="site-title">
  <h1>The Decision NAVigator</h1>
  <div class="sub">Bring clarity to complex decisions.</div>
</div>

<div class="wrap">
  <div class="card">
    <h1>D-NAV Variables</h1>
    <div class="muted">Rate each variable <i>in the moment</i>. These scores are relative to your current context.</div>
    <div class="scale-note">Scale: <span class="badge-inline">1 = minimal</span> <span class="badge-inline">10 = maximum</span> • judge how it feels <b>right now</b> (tomorrow may differ).</div>

    <div class="row">
      <label><span class="label-main" data-default="Impact">Impact</span><span class="hint" data-default="Expected benefit / upside.">Expected benefit / upside.</span></label>
      <input id="impact" type="range" min="1" max="10" value="1" />
      <output id="o_impact">1</output>
    </div>

    <div class="row">
      <label><span class="label-main" data-default="Cost">Cost</span><span class="hint" data-default="Money, time, or effort required.">Money, time, or effort required.</span></label>
      <input id="cost" type="range" min="1" max="10" value="1" />
      <output id="o_cost">1</output>
    </div>

    <div class="row">
      <label><span class="label-main" data-default="Risk">Risk</span><span class="hint" data-default="Downside, what could go wrong.">Downside, what could go wrong.</span></label>
      <input id="risk" type="range" min="1" max="10" value="1" />
      <output id="o_risk">1</output>
    </div>

    <div class="row">
      <label><span class="label-main" data-default="Urgency">Urgency</span><span class="hint" data-default="How soon action is needed.">How soon action is needed.</span></label>
      <input id="urgency" type="range" min="1" max="10" value="1" />
      <output id="o_urgency">1</output>
    </div>

    <div class="row">
      <label><span class="label-main" data-default="Confidence">Confidence</span><span class="hint" data-default="Evidence, readiness, and conviction.">Evidence, readiness, and conviction.</span></label>
      <input id="confidence" type="range" min="1" max="10" value="1" />
      <output id="o_confidence">1</output>
    </div>

    <div class="bar-controls">
      <label class="muted" style="display:flex;gap:6px;align-items:center;">
        <input id="aggrOn" type="checkbox" /> Aggressive window
      </label>
      <span class="muted">Allow Pressure up to <b>+2</b> when Return ≥ 0 for</span>
      <input id="aggrN" class="input" type="number" min="0" max="10" value="3" style="width:84px;text-align:right;" />
      <span class="muted">decision(s). <span id="aggrLeft" class="badge-inline" title="Remaining in window">left: 3</span></span>
    </div>

    <div class="muted" style="margin-top:6px;">Formula: <span class="mono">(Impact − Cost − Risk) + (Urgency × Confidence)</span></div>
  </div>

  <div class="card stats">
    <div class="stat"><h3>Return</h3><div class="val" id="ret">0</div><span id="retPill" class="pill amber">Neutral</span></div>
    <div class="stat"><h3>Stability</h3><div class="val" id="stab">0</div><span id="stabPill" class="pill amber">Uncertain</span></div>
    <div class="stat"><h3>Pressure</h3><div class="val" id="press">0</div><span id="pressPill" class="pill amber">Balanced</span></div>
  </div>

  <div class="card summary">
    <div class="arch"><h3>Archetype</h3><div id="arch" class="name">Routine</div><div id="archDesc" class="desc">Flat with uncertain footing — balanced execution.</div></div>
    <div class="comp">
      <h3>Composite (D-NAV)</h3>
      <div id="score" class="big">0</div>
      <div id="scoreTag" class="tag">Low D-NAV — Low energy</div>
      <div class="breakdown">Merit: <span id="meritVal" class="mono">0</span> • Drive: <span id="driveVal" class="mono">0</span></div>
      <div class="compare-inline"><button id="openCompareBtnA" class="btn"></button></div>
    </div>
    <div class="coach"><h3>Coach Readout</h3><div id="coach" class="txt">Greenlight profile — execute with discipline.</div></div>
  </div>
</div>

<!-- ENTRY + IMPORT -->
<div class="wrap" style="grid-template-columns:1fr 1fr;">
  <div class="card grid">
    <h2 style="margin:0;">Quick Entry</h2>
    <input id="decisionName" class="input" type="text" placeholder="Decision name (e.g., ‘Investor meetup solo’)" />
    <input id="decisionCategory" class="input" type="text" placeholder="Category (e.g., Career, Health, Relationships)" />
    <button id="enterBtn" class="btn" disabled>Enter decision</button>
    <div class="muted">Fill name & category, set sliders → click <b>Enter decision</b>. Stored on this device.</div>
  </div>

  <div class="card grid">
    <h2 style="margin:0;">Import</h2>
    <input id="csvInput" type="file" accept=".csv,text/csv" class="input" />
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="uploadBtn" class="btn" disabled>Confirm Import</button>
    </div>
    <div id="uploadMsg" class="muted"></div>
  </div>
</div>

<!-- STATS HUD + Distributions -->
<div class="wrap" style="grid-template-columns:1fr;">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <h2 style="margin:0;">Your Decision Stats</h2>
      <select id="rangeSelect" class="input" style="width:160px;padding:8px 10px;">
        <option value="0">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
      </select>
    </div>

    <div class="kpis">
      <div class="kpi" id="tile_total">
        <h4>Decisions (in window)</h4>
        <div class="big" id="k_total" data-val="0">0</div>
        <div class="mini" id="k_recent">—</div>
      </div>
      <div class="kpi" id="tile_avg">
        <h4>Avg D-NAV</h4>
        <div class="big" id="k_avgdnav" data-val="0">0</div>
        <div class="mini">Composite (Merit + Drive)</div>
      </div>

      <div class="kpi" id="tile_mom">
        <h4>Trend</h4>
        <div class="big" id="k_momentum" data-val="0">0</div>
        <div class="mini">Short-term vs baseline (EMA7 − EMA30)</div>
      </div>
      <div class="kpi" id="tile_cons">
        <h4>Consistency</h4>
        <div class="big" id="k_consistency" data-val="0">0</div>
        <div class="mini">Steadiness (lower σ = steadier)</div>
      </div>
      <div class="kpi" id="tile_cad">
        <h4>Cadence</h4>
        <div class="big" id="k_cadence" data-val="0">0</div>
        <div class="mini">Decisions / week (window)</div>
      </div>
      <div class="kpi" id="tile_calib">
        <h4>Calibration</h4>
        <div class="big" id="k_calib" data-val="0">0</div>
        <div class="mini">Confidence ↔ Return (corr)</div>
      </div>

      <div class="kpi" id="tile_last5">
        <h4>Last-5 vs Prior-5</h4>
        <div class="big" id="k_last5" data-val="0">0</div>
        <div class="mini" id="k_last5mini">—</div>
      </div>

      <!-- NEW: Loss hygiene -->
      <div class="kpi" id="tile_loss">
        <h4>Loss Streak</h4>
        <div class="big" id="k_loss">0 / 0</div>
        <div class="mini">Current / Longest (Return &lt; 0)</div>
      </div>
      <div class="kpi" id="tile_debt">
        <h4>Return Debt</h4>
        <div class="big" id="k_debt">0</div>
        <div class="mini" id="k_debtmini">Sum of losses in current streak</div>
      </div>
      <div class="kpi" id="tile_payback">
        <h4>Payback Ratio</h4>
        <div class="big" id="k_payback">—</div>
        <div class="mini" id="k_paybackmini"># of avg wins to break even</div>
      </div>
    </div>

    <div class="kpi" id="tile_policy" style="margin-top:10px;">
      <h4>Policy Hint</h4>
      <div class="big" id="k_policy">—</div>
      <div class="mini" id="k_policymini">Guardrail: pause after 3 losses or if Payback &gt; 2×</div>
    </div>

    <!-- Distributions -->
    <div class="dist-card" id="dist_return">
      <h3>Return distribution</h3>
      <div class="stack">
        <div class="seg g" id="ret_pos" style="width:0%"></div>
        <div class="seg a" id="ret_neu" style="width:0%"></div>
        <div class="seg r" id="ret_neg" style="width:0%"></div>
      </div>
      <div class="legend"><span id="ret_pos_lbl">Positive: 0%</span><span id="ret_neu_lbl">Neutral: 0%</span><span id="ret_neg_lbl">Negative: 0%</span></div>
    </div>

    <div class="dist-card" id="dist_stab">
      <h3>Stability distribution</h3>
      <div class="stack">
        <div class="seg g" id="st_st" style="width:0%"></div>
        <div class="seg a" id="st_un" style="width:0%"></div>
        <div class="seg r" id="st_fr" style="width:0%"></div>
      </div>
      <div class="legend"><span id="st_st_lbl">Stable: 0%</span><span id="st_un_lbl">Uncertain: 0%</span><span id="st_fr_lbl">Fragile: 0%</span></div>
    </div>

    <div class="dist-card" id="dist_press">
      <h3>Pressure distribution</h3>
      <div class="stack">
        <div class="seg r" id="pr_pr" style="width:0%"></div>
        <div class="seg a" id="pr_bal" style="width:0%"></div>
        <div class="seg g" id="pr_calm" style="width:0%"></div>
      </div>
      <div class="legend"><span id="pr_pr_lbl">Pressured: 0%</span><span id="pr_bal_lbl">Balanced: 0%</span><span id="pr_calm_lbl">Calm: 0%</span></div>
    </div>

    <h3 id="allocTitle" style="margin:14px 0 6px;">Drive (U×C) by category</h3>
    <div class="alloc" id="allocList"></div>

    <div class="mini" id="k_losscats" style="margin-top:8px;">Active loss streaks by category: —</div>

    <div class="mini" id="k_misc" style="margin-top:8px;">Top category: — • Top archetype: —</div>
  </div>
</div>

<!-- LOG -->
<div class="wrap" style="grid-template-columns:1fr;">
  <div class="card grid">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
      <h2 style="margin:0;">Decision Log</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <label class="muted" style="display:flex;gap:6px;align-items:center">
          <input id="compactPrint" type="checkbox" /> Compact print
        </label>
        <button id="downloadPdfBtn" class="btn secondary">Print / Save as PDF</button>
        <button id="downloadCsvBtn" class="btn secondary">Download CSV</button>
        <button id="clearLogBtn" class="btn secondary">Clear</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="logTable">
        <thead>
          <tr>
            <th>When</th>
            <th>Name</th>
            <th>Category</th>
            <th style="text-align:right;">Impact</th>
            <th style="text-align:right;">Cost</th>
            <th style="text-align:right;">Risk</th>
            <th style="text-align:right;">Urgency</th>
            <th style="text-align:right;">Confidence</th>
            <th style="text-align:right;">Return</th>
            <th style="text-align:right;">Pressure</th>
            <th style="text-align:right;">Stability</th>
            <th style="text-align:right;">D-NAV</th>
            <th style="text-align:center;">✕</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- FOOTER LINKS -->
<div class="footer-links">
  <a href="/definitions.html">View definitions & archetypes</a>
  <a target="_blank" rel="noopener noreferrer" href="https://decisionnavigator.gumroad.com/">Start tracking all of your decisions</a>
</div>

<div style="display:flex;flex:1;justify-content:center;align-items:center;margin-top:4px;">
  <img src="./logo.PNG" style="background-color:#c9d4e6;width:100px;height:100px;border-radius:8px;" alt="D-NAV logo"/>
</div>

<!-- Floating Compare FAB -->
<button id="openCompareFab" class="fab pulse" aria-label="Open Compare"></button>

<!-- Compare Modal -->
<div id="compareModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <header>
      <div>
        <h2 style="display:flex;align-items:center;gap:8px;">
          <span class="chip blue">BASE</span> vs <span class="chip green">SCENARIOS</span>
        </h2>
        <div class="muted" style="margin-top:4px;">
          Base = current sliders <span id="baseLockState">(locked)</span> • Add unlimited scenarios and set any as Base.
        </div>
      </div>
      <div class="actions" style="position:relative;">
        <label class="muted" style="display:flex;align-items:center;gap:6px;">
          <input id="baseLock" type="checkbox" checked/> Lock Base to sliders
        </label>
        <label class="muted" style="display:flex;align-items:center;gap:6px;">
          <input id="simpleMode" type="checkbox"/> Simple mode
        </label>
        <select id="recentSelect" class="input" style="padding:8px 10px;">
          <option value="">Load from recent…</option>
        </select>
        <button id="moreRecentBtn" class="closeX" title="Browse all">More…</button>
        <div id="morePanel" class="more-panel" role="dialog" aria-modal="true" aria-label="All recent decisions">
          <button id="moreClose" class="more-close">Close</button>
          <div id="moreList"></div>
        </div>
        <button id="addScenarioBtn" class="cta">Add Scenario</button>
        <button id="closeCompareBtn" class="closeX" title="Close (Esc)">Close</button>
      </div>
    </header>

    <div class="body">
      <div class="helper">
        <b>How to use:</b> 1) Add a scenario. 2) Tweak its sliders. 3) Read deltas vs Base and easiest-change suggestions.<br>
        <span style="color:#a7b4c7">“Easiest change” = the single input with the smallest % change (≈ fewest ticks) that hits your goal.</span>
      </div>

      <div class="dual" style="margin-top:12px;">
        <!-- LEFT: Base summary -->
        <div class="card col-base">
          <h1 style="margin-bottom:2px;">Base <span class="chip blue">CURRENT</span></h1>
          <div class="muted" id="B_meta">—</div>
          <div class="kpis" style="margin-top:10px;">
            <div class="kpi"><h4>Return</h4><div class="big" id="B_ret">0</div></div>
            <div class="kpi"><h4>Stability</h4><div class="big" id="B_stab">0</div></div>
            <div class="kpi"><h4>Pressure</h4><div class="big" id="B_press">0</div></div>
          </div>
          <div class="kpi" style="margin-top:8px;"><h4>D-NAV</h4><div class="big" id="B_dnav">0</div></div>
          <div class="muted" id="B_tldr" style="margin-top:10px;">—</div>

          <!-- Delta Board fills the previous blank space -->
          <div class="delta-board" id="deltaBoard" style="display:none">
            <h4>Scenarios vs Base</h4>
            <table class="delta-table" id="deltaTable">
              <thead>
                <tr>
                  <th>Scenario</th>
                  <th>Δ Return</th>
                  <th>Δ Stability</th>
                  <th>Δ Pressure</th>
                  <th style="width:160px;">Δ D-NAV</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- RIGHT: Scenarios container -->
        <div class="card col-scenario">
          <h1 style="margin-bottom:2px;">Scenarios</h1>
          <div id="scenarios" class="scenarios"></div>
        </div>
      </div>

      <!-- Winner summary -->
      <div style="margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span id="winnerTag" class="win">—</span>
        <div id="winnerLine" class="muted">Add/tweak scenarios to see which option leads on D-NAV.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---- One-word archetypes (keyed by P|S|R) ---- */
const oneWord={
  "1|1|1":"Breakthrough","0|1|1":"Advance","-1|1|1":"Harvest",
  "1|0|1":"Sprint","0|0|1":"Build","-1|0|1":"Coast",
  "1|-1|1":"Gamble","0|-1|1":"Moonshot","-1|-1|1":"Prospect",
  "1|1|0":"Grind","0|1|0":"Maintain","-1|1|0":"Idle",
  "1|0|0":"Firefight","0|0|0":"Routine","-1|0|0":"Drift",
  "1|-1|0":"Strain","0|-1|0":"Wobble","-1|-1|0":"Teeter",
  "1|1|-1":"Overreach","0|1|-1":"Erode","-1|1|-1":"Complacency",
  "1|0|-1":"Burn","0|0|-1":"Waste","-1|0|-1":"Leak",
  "1|-1|-1":"Meltdown","0|-1|-1":"Collapse","-1|-1|-1":"Decay"
};

const Pword = s => s>0?'Pressured':(s<0?'Calm':'Balanced');
const Sword = s => s>0?'Stable':(s<0?'Fragile':'Uncertain');
const Rword = s => s>0?'Gain':(s<0?'Loss':'Flat');
const lineFor = (p,s,r) => `${Rword(r)} with ${Sword(s).toLowerCase()} footing — ${Pword(p).toLowerCase()} execution.`;

function sign3(x){return x>0?1:x<0?-1:0;}
function badge(el,state,pw,nw,gw){el.className="pill "+(state>0?"green":(state<0?"red":"amber"));el.textContent=state>0?pw:(state<0?gw:nw);}
function scoreTagText(n){return n>=80?"Very high D-NAV":n>=50?"High D-NAV":n>=25?"Moderate D-NAV":"Low D-NAV";}

/* Energy tiers */
function energyTier(u, c){
  const e = (u||0) * (c||0);
  if (e >= 71) return {e, name:"Overdrive energy", short:"overdrive"};
  if (e >= 41) return {e, name:"High energy",      short:"high"};
  if (e >= 16) return {e, name:"Moderate energy",  short:"moderate"};
  return {e, name:"Low energy", short:"low"};
}

/* Aggressive window state */
function getAggressiveState(){
  const on   = document.getElementById('aggrOn').checked;
  const left = Number(localStorage.getItem('dnav_aggr_left') ?? (document.getElementById('aggrN').value || 0));
  const cap  = Number(document.getElementById('aggrN').value || 0);
  return {on, left: Math.max(0, Math.min(cap, left)), cap};
}
function setAggressiveLeft(n){
  const {cap} = getAggressiveState();
  const left = Math.max(0, Math.min(cap, Number(n)||0));
  localStorage.setItem('dnav_aggr_left', String(left));
  const tag = document.getElementById('aggrLeft');
  if(tag) tag.textContent = `left: ${left}`;
}

/* Coach text (respects aggressive window) */
function coachHint({ret, stab, press, urg, conf, impact, cost, risk}){
  const {on, left} = getAggressiveState();
  const allowPress = (on && left>0 && ret>=0) ? 2 : 0; // “Aggressive: allow Pressure up to +2 for ≤N decisions if Return↑”
  const adjPress = (press>0 && press<=allowPress) ? 0 : press;

  const et = energyTier(urg, conf);
  let sugs = [];
  const needRaiseImpact = (impact <= cost) && (ret <= 0);
  const needLowerCosts  = (impact <= cost) && (ret <= 0);
  const needLowerRisks  = (risk >= conf);
  const needAddEvidence = (stab <= 0);
  const needNarrowScope = (adjPress > 0);
  const needAddCapacity = (adjPress > 0 && (et.short === "overdrive" || et.short === "high"));

  if (needRaiseImpact) sugs.push("raise impact");
  if (needLowerCosts)  sugs.push("lower costs");
  if (needLowerRisks)  sugs.push("lower risks");
  if (needAddEvidence) sugs.push("add evidence");
  if (needNarrowScope) sugs.push("narrow scope");
  if (needAddCapacity) sugs.push("add capacity");

  const hasCosts = sugs.includes("lower costs");
  const hasRisks = sugs.includes("lower risks");
  if (hasCosts || hasRisks){
    sugs = sugs.filter(s=>s!=="lower costs" && s!=="lower risks");
    sugs.push(hasCosts && hasRisks ? "lower costs and/or risks" : (hasCosts ? "lower costs" : "lower risks"));
  }

  sugs = [...new Set(sugs)].slice(0,2);
  const leverLine = sugs.length ? " — " + sugs.join("; ") + "." : ".";

  if (ret < 0){
    const base = (et.short==="high"||et.short==="overdrive")
      ? "High energy chasing negative return — stop or pivot"
      : "Negative return — improve unit economics";
    return base + leverLine;
  }

  if (ret === 0){
    let base = "Neutral return";
    if (adjPress > 0 && stab <= 0) base += " under pressure on fragile footing";
    else if (adjPress > 0)         base += " under pressure";
    else if (stab <= 0)            base += " but fragile";
    return base + leverLine;
  }

  if (stab <= 0 && adjPress > 0) return "Upside with fragile footing and pressure" + leverLine;
  if (stab <= 0)                 return "Upside but fragile — shore up footing before scaling" + leverLine;
  if (adjPress > 0)              return "Good profile, but pressured" + leverLine;

  // If aggressive window absorbed the pressure, call it out.
  if (press>0 && allowPress>0 && press<=allowPress) return "Greenlight profile — within aggressive window; monitor pressure." + leverLine;
  return sugs.length ? "Greenlight profile" + leverLine : "Greenlight profile — execute with discipline.";
}

/* Main calculator compute */
function compute(){
  const impact=+document.getElementById('impact').value;
  const cost=+document.getElementById('cost').value;
  const risk=+document.getElementById('risk').value;
  const urgency=+document.getElementById('urgency').value;
  const confidence=+document.getElementById('confidence').value;

  document.getElementById('o_impact').textContent=impact;
  document.getElementById('o_cost').textContent=cost;
  document.getElementById('o_risk').textContent=risk;
  document.getElementById('o_urgency').textContent=urgency;
  document.getElementById('o_confidence').textContent=confidence;

  const ret = impact - cost;
  const stab = confidence - risk;
  const pressRaw = urgency - confidence;

  // Aggressive allowance affects display/coach, not the underlying math.
  const {on, left} = getAggressiveState();
  const allowPress = (on && left>0 && ret>=0) ? 2 : 0;
  const pressAbsorbed = (pressRaw>0 && pressRaw<=allowPress);

  const merit = impact - cost - risk;
  const eInfo = energyTier(urgency, confidence);
  const composite = merit + eInfo.e;
  const s = x => x>0?('+'+x):(x<0?x.toString():'0');

  document.getElementById('ret').textContent=s(ret);
  document.getElementById('stab').textContent=s(stab);
  document.getElementById('press').textContent=s(pressRaw);

  badge(document.getElementById('retPill'),Math.sign(ret),'Positive','Neutral','Negative');
  badge(document.getElementById('stabPill'),Math.sign(stab),'Stable','Uncertain','Fragile');

  const pressPill = document.getElementById('pressPill');
  if(pressAbsorbed){
    pressPill.textContent = 'Pressured (allowed)';
    pressPill.className = 'pill blue';
  }else{
    pressPill.textContent = pressRaw > 0 ? 'Pressured' : (pressRaw < 0 ? 'Calm' : 'Balanced');
    pressPill.className = 'pill ' + (pressRaw > 0 ? 'red' : (pressRaw < 0 ? 'green' : 'amber'));
  }

  const pS=sign3(pressRaw), sS=sign3(stab), rS=sign3(ret);
  const name=oneWord[[pS,sS,rS].join('|')]||'Unclassified';
  document.getElementById('arch').textContent=name;
  document.getElementById('archDesc').textContent=lineFor(pS,sS,rS);

  document.getElementById('score').textContent=composite;
  document.getElementById('scoreTag').textContent = `${scoreTagText(composite)} — ${energyTier(urgency, confidence).name}`;
  document.getElementById('meritVal').textContent = merit;
  document.getElementById('driveVal').textContent = eInfo.e;

  document.getElementById('coach').textContent = coachHint({
    ret, stab, press: pressRaw, urg: urgency, conf: confidence, impact, cost, risk
  });

  if(document.getElementById('compareModal').getAttribute('aria-hidden')==='false'){
    if(document.getElementById('baseLock').checked) updateBaseInModal();
    recomputeAllScenarios();
  }
}

/* ---------- CSV / PDF / Stats / Log ---------- */
function fmtLocal(ts){
  const d = new Date(ts);
  const z = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}
const $ = (sel) => document.querySelector(sel);
const SLIDER_IDS = ["impact","cost","risk","urgency","confidence"];
const fmt0 = (n) => Number(n).toFixed(0);
function readCurrent(){ const out={}; SLIDER_IDS.forEach(id=>out[id]=Number($('#'+id).value||0)); return out; }

/* Math helpers */
function ema(arr, span){
  if(!arr.length) return 0;
  const alpha = 2/(span+1);
  let e = arr[0];
  for(let i=1;i<arr.length;i++){ e = alpha*arr[i] + (1-alpha)*e; }
  return e;
}
function stdev(arr){
  if(arr.length<2) return 0;
  const m = arr.reduce((a,b)=>a+b,0)/arr.length;
  const v = arr.reduce((a,b)=>a+(b-m)*(b-m),0)/(arr.length-1);
  return Math.sqrt(v);
}
function corr(x,y){
  const n = Math.min(x.length,y.length);
  if(n<3) return null;
  const xs=x.slice(0,n), ys=y.slice(0,n);
  const mx = xs.reduce((a,b)=>a+b,0)/n;
  const my = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, dx=0, dy=0;
  for(let i=0;i<n;i++){ const vx=xs[i]-mx, vy=ys[i]-my; num+=vx*vy; dx+=vx*vx; dy+=vy*vy; }
  const den = Math.sqrt(dx*dy);
  if(den===0) return 0;
  return num/den;
}

function computeMetrics(v){
  const ret=v.impact - v.cost;
  const pressure=v.urgency - v.confidence;
  const stability=v.confidence - v.risk;
  const merit = v.impact - v.cost - v.risk;
  const eInfo = energyTier(v.urgency, v.confidence);
  const dnav = merit + eInfo.e;
  return {ret,pressure,stability,dnav,merit,energy:eInfo.e};
}
function loadLog(){ try{ return JSON.parse(localStorage.getItem('dnav_log_v1')||'[]'); }catch{ return []; } }
function saveLog(arr){ localStorage.setItem('dnav_log_v1', JSON.stringify(arr)); }
function escapeHtml(s=''){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* CSV parsing */
function parseCSV(text){
  const rows=[]; let i=0, cur=[], val='', inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){ val+='"'; i+=2; continue; }
      if(c==='"' ){ inQ=false; i++; continue; }
      val+=c; i++; continue;
    }else{
      if(c==='"' ){ inQ=true; i++; continue; }
      if(c===','){ cur.push(val); val=''; i++; continue; }
      if(c==='\n'){ cur.push(val); rows.push(cur); cur=[]; val=''; i++; continue; }
      if(c==='\r'){
        if(text[i+1]==='\n'){ i+=2; cur.push(val); rows.push(cur); cur=[]; val=''; continue; }
        cur.push(val); rows.push(cur); cur=[]; val=''; i++; continue;
      }
      val+=c; i++; continue;
    }
  }
  cur.push(val); rows.push(cur);
  while(rows.length && rows[rows.length-1].every(x=>x==='')) rows.pop();
  return rows;
}
const headerAliases = {
  name:['name','decision','title','decision_name'],
  category:['category','cat'],
  impact:['impact','i'],
  cost:['cost','c'],
  risk:['risk','r'],
  urgency:['urgency','u'],
  confidence:['confidence','conf'],
  timestamp:['timestamp','when','date','time','timestamp_iso','timestamp_local','ts'],
  prompt:['prompt','question']
};
function findHeaderIndex(headers, key){
  const lowers=headers.map(h=>String(h||'').trim().toLowerCase());
  const cands=headerAliases[key]||[key];
  for(const cand of cands){
    const idx=lowers.indexOf(cand);
    if(idx>-1) return idx;
  }
  return -1;
}
function toNumberOrNull(x){
  if(x===undefined || x===null) return null;
  const n=Number(String(x).trim());
  return Number.isFinite(n) ? n : null;
}

/* De-dupe on import */
function dedupeRows(rows){
  const seen = new Set(), out = [];
  for(const r of rows){
    const key = [String(r.name||''), String(r.category||''), String(r.ts||'')].join('|');
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(r);
  }
  return out;
}

/* Import pipeline */
function importCSV(text){
  const rows=parseCSV(text);
  if(!rows.length) throw new Error('CSV appears empty.');
  const headers=rows[0]; const data=rows.slice(1);

  const idx={
    name: findHeaderIndex(headers,'name'),
    category: findHeaderIndex(headers,'category'),
    impact: findHeaderIndex(headers,'impact'),
    cost: findHeaderIndex(headers,'cost'),
    risk: findHeaderIndex(headers,'risk'),
    urgency: findHeaderIndex(headers,'urgency'),
    confidence: findHeaderIndex(headers,'confidence'),
    timestamp: findHeaderIndex(headers,'timestamp'),
    prompt: findHeaderIndex(headers,'prompt')
  };

  if(idx.name===-1 && idx.prompt===-1)
    throw new Error('Missing a "name" or "prompt" column.');
  if(idx.category===-1)
    throw new Error('Missing a "category" column.');

  const imported=[];
  for(const row of data){
    const nameRaw = idx.name>-1 ? row[idx.name] : '';
    const promptRaw = idx.prompt>-1 ? row[idx.prompt] : '';
    const name = String((nameRaw||'').trim() || (promptRaw||'').trim());
    const category = String((row[idx.category]||'').trim());
    if(!name && !category) continue;
    if(!category) throw new Error('Some rows are missing Category.');

    const vals = {
      impact: toNumberOrNull(idx.impact>-1 ? row[idx.impact] : null) ?? 0,
      cost: toNumberOrNull(idx.cost>-1 ? row[idx.cost] : null) ?? 0,
      risk: toNumberOrNull(idx.risk>-1 ? row[idx.risk] : null) ?? 0,
      urgency: toNumberOrNull(idx.urgency>-1 ? row[idx.urgency] : null) ?? 0,
      confidence: toNumberOrNull(idx.confidence>-1 ? row[idx.confidence] : null) ?? 0
    };

    const m = computeMetrics(vals);

    let ts = Date.now();
    if(idx.timestamp>-1){
      const tms = Date.parse(row[idx.timestamp]);
      if(Number.isFinite(tms)) ts = tms;
    }

    imported.push({
      ts,name,category,
      ...vals,
      return:m.ret, pressure:m.pressure, stability:m.stability, merit:m.merit, energy:m.energy, dnav:m.dnav
    });
  }

  if(!imported.length) throw new Error('No usable rows were found.');

  const current = loadLog();
  imported.sort((a,b)=>b.ts-a.ts);
  const merged = dedupeRows([...imported, ...current]);
  saveLog(merged);
  populateRecent();
  return {count: imported.length};
}

function toCsv(rows){
  const header=['timestamp_local','timestamp_iso','name','category','impact','cost','risk','urgency','confidence','return','pressure','stability','merit','energy','dnav'];
  const body=rows.map(r=>[
    fmtLocal(r.ts), new Date(r.ts).toISOString(),
    `"${(r.name||'').replace(/"/g,'""')}"`,
    `"${(r.category||'').replace(/"/g,'""')}"`,
    r.impact,r.cost,r.risk,r.urgency,r.confidence,r.return,r.pressure,r.stability,r.merit,r.energy,r.dnav
  ].join(','));
  return [header.join(','),...body].join('\n');
}
function downloadCsv(){
  const rows=loadLog();
  if(!rows.length){ alert('No decisions logged yet.'); return; }
  const blob=new Blob([toCsv(rows)],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='dnav_decisions.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* -------- Compact, one-page-leaning PDF report -------- */
function openPdfReport(){
  const compact = document.getElementById('compactPrint')?.checked === true;

  const all = loadLog();
  const inRange = filterRows(all);
  const total = inRange.length;
  const avg = total ? Math.round(inRange.reduce((a,r)=>a + (Number(r.dnav)||0),0)/total) : 0;
  const daysSel = Number($('#rangeSelect').value||0);
  const windowLbl = daysSel? `Last ${daysSel} days` : 'All time';

  const pct = (n,d)=> d ? Math.round(n*100/d) : 0;
  const count = (fn)=> inRange.filter(fn).length;

  const retPos = count(r=>r.return>0), retNeu=count(r=>r.return===0), retNeg=count(r=>r.return<0);
  const stabSt = count(r=>r.stability>0), stabUn=count(r=>r.stability===0), stabFr=count(r=>r.stability<0);
  const prPress = count(r=>r.pressure>0), prBal=count(r=>r.pressure===0), prCalm=count(r=>r.pressure<0);

  const asc=[...inRange].sort((a,b)=>a.ts-b.ts);
  const dnavAsc=asc.map(r=>Number(r.dnav)||0);
  const ema7 = dnavAsc.length? Math.round(ema(dnavAsc,7)) : 0;
  const ema30= dnavAsc.length? Math.round(ema(dnavAsc,30)) : 0;
  const trend = ema7-ema30;
  const last20 = dnavAsc.slice(-20);
  const consistency = Math.round(stdev(last20));
  let cadence = 0;
  if(asc.length){
    const first=asc[0].ts, last=asc[asc.length-1].ts;
    const days = Math.max(1,(last-first)/86400000);
    cadence = Math.round((total/days)*7);
  }

  const confs = asc.map(r=>Number(r.confidence)||0);
  const rets  = asc.map(r=>Number(r.return)||0);
  const cal = corr(confs,rets);
  const calDisp = (cal===null)?'n/a':(cal>=0?'+':'')+ (Math.round(cal*100)/100);

  const html = `
  <html><head><meta charset="utf-8" />
    <title>D-NAV Insights</title>
    <style>
      :root{--bg:#0b0f14;--card:#121821;--text:#e9eef5;--muted:#a7b4c7;--g:#3ecf8e;--r:#ff6b6b;--a:#f3b431}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font:${compact?'12px':'14px'}/1.35 Inter,system-ui,Segoe UI,Roboto,Arial}
      .container{max-width:1200px;margin:0 auto;padding:${compact?'16px':'24px'}}
      h1{margin:0 0 ${compact?'8px':'12px'};font-size:${compact?'18px':'22px'};font-weight:900}
      h2{margin:${compact?'10px':'14px'} 0 ${compact?'6px':'8px'};font-size:${compact?'14px':'16px'}}
      .grid{display:grid;grid-template-columns:${compact?'1fr 1fr':'1fr'};gap:${compact?'8px':'10px'}}
      .card{background:var(--card);border-radius:12px;padding:${compact?'8px':'12px'};margin:${compact?'6px':'10px'} 0}
      .kpi{background:rgba(255,255,255,.05);border-radius:10px;padding:${compact?'8px':'10px'}}
      .kpi h4{margin:0;font-size:${compact?'10px':'11px'};color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
      .big{font-size:${compact?'18px':'22px'};font-weight:900;margin-top:${compact?'2px':'4px'}}
      .mini{color:var(--muted);font-size:${compact?'11px':'12px'}}
      .stack{height:${compact?'8px':'10px'};border-radius:999px;background:rgba(255,255,255,.09);display:flex;overflow:hidden;margin-top:${compact?'4px':'6px'}}
      .seg{height:100%}.g{background:rgba(62,207,142,.85)}.a{background:rgba(243,180,49,.85)}.r{background:rgba(255,107,107,.85)}
      .legend{display:${compact?'none':'flex'};gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px}
      @page{size: ${compact?'Letter':'auto'}; margin:${compact?'.5in':'1in'}}
      @media print{body{background:#fff;color:#000}.card{background:#fff;border:1px solid #ddd}.kpi,.stack{background:#eee}.g{background:#4caf50}.a{background:#ffb300}.r{background:#ef5350}}
    </style>
  </head>
  <body>
    <div class="container">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:${compact?'6px':'10px'}">
        <h1>D-NAV Insights — ${windowLbl}</h1>
        <span class="mini">Generated ${new Date().toLocaleString()}</span>
      </div>

      <div class="card">
        <h2>Executive summary</h2>
        <div class="mini">Entries ${total} • Avg D-NAV ${avg} • Trend ${trend>=0?'+':''}${trend} • σ ${consistency} • Cadence ${cadence}/wk • Calibration ${calDisp}</div>
        ${compact? '' : '<div class="mini" style="margin-top:6px">D-NAV = (Impact − Cost − Risk) + (Urgency × Confidence).</div>'}
      </div>

      <div class="grid">
        <div class="kpi"><h4>Decisions</h4><div class="big">${total}</div></div>
        <div class="kpi"><h4>Avg D-NAV</h4><div class="big">${avg}</div></div>
        <div class="kpi"><h4>Trend</h4><div class="big">${trend>=0?'+':''}${trend}</div><div class="mini">EMA7−EMA30</div></div>
        <div class="kpi"><h4>Consistency</h4><div class="big">${consistency}</div><div class="mini">Lower σ better</div></div>
        <div class="kpi"><h4>Cadence</h4><div class="big">${cadence}</div><div class="mini">Decisions/week</div></div>
        <div class="kpi"><h4>Calibration</h4><div class="big">${calDisp}</div><div class="mini">Conf ↔ Return</div></div>
      </div>

      <div class="grid">
        <div class="card"><h2>Return distribution</h2>
          <div class="stack"><span class="seg g" style="width:${pct(retPos,total)}%"></span><span class="seg a" style="width:${pct(retNeu,total)}%"></span><span class="seg r" style="width:${pct(retNeg,total)}%"></span></div>
        </div>
        <div class="card"><h2>Stability distribution</h2>
          <div class="stack"><span class="seg g" style="width:${pct(stabSt,total)}%"></span><span class="seg a" style="width:${pct(stabUn,total)}%"></span><span class="seg r" style="width:${pct(stabFr,total)}%"></span></div>
        </div>
        ${compact ? '' : `
        <div class="card"><h2>Pressure distribution</h2>
          <div class="stack"><span class="seg r" style="width:${pct(prPress,total)}%"></span><span class="seg a" style="width:${pct(prBal,total)}%"></span><span class="seg g" style="width:${pct(prCalm,total)}%"></span></div>
        </div>`}
      </div>
    </div>
  </body></html>`;

  const w = window.open('', '_blank');
  if(!w){ alert('Please allow pop-ups to view the PDF.'); return; }
  w.document.open(); w.document.write(html); w.document.close();
  try{ w.focus(); }catch{}
}

/* ---------- Animated Stats / rendering ---------- */
function animateNumber(el, to, {suffix='', duration=500}={}){
  const from = Number(el.dataset.val || 0);
  const start = performance.now();
  function step(t){
    const p = Math.min(1, (t - start)/duration);
    const v = Math.round(from + (to - from)*p);
    el.textContent = v + suffix;
    if(p < 1){ requestAnimationFrame(step); } else { el.dataset.val = to; }
  }
  requestAnimationFrame(step);
}
function pulse(tile){ tile.classList.remove('pulse'); void tile.offsetWidth; tile.classList.add('pulse'); }
function filterRows(rows){
  const days = Number($('#rangeSelect').value || 0);
  if(!days) return rows;
  const cutoff = Date.now() - days*24*60*60*1000;
  return rows.filter(r=>r.ts >= cutoff);
}

/* Alloc & distributions */
function renderAlloc(rows){
  const list = $('#allocList');
  if(!rows.length){ list.innerHTML = '<div class="mini">No data in range.</div>'; return; }
  const totals = new Map(); let energyAll = 0;
  rows.forEach(r=>{
    const cat=(r.category||'').trim()||'Uncategorized';
    const e = (r.urgency||0)*(r.confidence||0);
    energyAll += e;
    if(!totals.has(cat)) totals.set(cat,{energy:0,count:0,sumD:0,press:0,stable:0});
    const t=totals.get(cat);
    t.energy += e; t.count += 1; t.sumD += (Number(r.dnav)||0);
    if((r.pressure||0) > 0) t.press += 1;
    if((r.stability||0) > 0) t.stable += 1;
  });
  const rowsData = Array.from(totals.entries()).map(([cat,t])=>{
    const share = energyAll? Math.round(t.energy*100/energyAll) : 0;
    const avgD = Math.round(t.sumD / t.count);
    const pr = Math.round(t.press*100/t.count);
    const st = Math.round(t.stable*100/t.count);
    return {cat, share, avgD, count:t.count, pr, st};
  }).sort((a,b)=>b.share-a.share).slice(0,8);

  list.innerHTML = rowsData.map(r=>`
    <div class="row">
      <div><strong>${escapeHtml(r.cat)}</strong></div>
      <div class="bar"><span style="width:${r.share}%"></span></div>
      <div class="meta">${r.share}% of drive • ${r.count} decisions • avg D-NAV ${r.avgD} • stable ${r.st}% • pressured ${r.pr}%</div>
    </div>
  `).join('');
}
function renderDists(rows){
  const total = rows.length || 1;

  const count = (fn)=> rows.filter(fn).length;
  const retPos = count(r=>r.return>0), retNeu=count(r=>r.return===0), retNeg=count(r=>r.return<0);
  const stSt = count(r=>r.stability>0), stUn=count(r=>r.stability===0), stFr=count(r=>r.stability<0);
  const prPr = count(r=>r.pressure>0), prBa=count(r=>r.pressure===0), prCa=count(r=>r.pressure<0);

  const pct = (n)=> Math.round(n*100/total);

  document.getElementById('ret_pos').style.width = pct(retPos)+'%';
  document.getElementById('ret_neu').style.width = pct(retNeu)+'%';
  document.getElementById('ret_neg').style.width = pct(retNeg)+'%';
  document.getElementById('ret_pos_lbl').textContent = `Positive: ${pct(retPos)}%`;
  document.getElementById('ret_neu_lbl').textContent = `Neutral: ${pct(retNeu)}%`;
  document.getElementById('ret_neg_lbl').textContent = `Negative: ${pct(retNeg)}%`;

  document.getElementById('st_st').style.width = pct(stSt)+'%';
  document.getElementById('st_un').style.width = pct(stUn)+'%';
  document.getElementById('st_fr').style.width = pct(stFr)+'%';
  document.getElementById('st_st_lbl').textContent = `Stable: ${pct(stSt)}%`;
  document.getElementById('st_un_lbl').textContent = `Uncertain: ${pct(stUn)}%`;
  document.getElementById('st_fr_lbl').textContent = `Fragile: ${pct(stFr)}%`;

  document.getElementById('pr_pr').style.width = pct(prPr)+'%';
  document.getElementById('pr_bal').style.width = pct(prBa)+'%';
  document.getElementById('pr_calm').style.width = pct(prCa)+'%';
  document.getElementById('pr_pr_lbl').textContent = `Pressured: ${pct(prPr)}%`;
  document.getElementById('pr_bal_lbl').textContent = `Balanced: ${pct(prBa)}%`;
  document.getElementById('pr_calm_lbl').textContent = `Calm: ${pct(prCa)}%`;
}

/* ===== NEW: Loss hygiene helpers ===== */
function lossHygiene(rows){
  const desc = [...rows].sort((a,b)=>b.ts-a.ts);
  // current streak and debt
  let current=0, debt=0;
  for(const r of desc){
    if((r.return||0) < 0){ current++; debt += Math.abs(r.return||0); }
    else break;
  }
  // longest streak
  let longest=0, run=0;
  for(const r of desc){
    if((r.return||0) < 0){ run++; longest = Math.max(longest, run); }
    else run = 0;
  }
  // average positive return
  const pos = rows.filter(r=> (r.return||0) > 0).map(r=>r.return||0);
  const avgPos = pos.length ? (pos.reduce((a,b)=>a+b,0)/pos.length) : 0;
  const payback = (avgPos>0) ? Math.ceil(debt / avgPos) : Infinity;
  return {current, longest, debt:Math.round(debt), avgPos:Math.round(avgPos*100)/100, payback};
}
function lossByCategory(rows){
  // compute current loss streak per category (only categories with active streak>0)
  const byCat = new Map();
  const grouped = new Map();
  rows.forEach(r=>{
    const c=(r.category||'Uncategorized').trim();
    if(!grouped.has(c)) grouped.set(c,[]);
    grouped.get(c).push(r);
  });
  grouped.forEach((arr,cat)=>{
    const desc = arr.sort((a,b)=>b.ts-a.ts);
    let cur=0;
    for(const r of desc){
      if((r.return||0)<0) cur++;
      else break;
    }
    if(cur>0) byCat.set(cat,cur);
  });
  return [...byCat.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
}
function renderLossTiles(rows){
  const h = lossHygiene(rows);
  document.getElementById('k_loss').textContent = `${h.current} / ${h.longest}`;
  document.getElementById('k_debt').textContent = `${h.debt}`;
  document.getElementById('k_debtmini').textContent = `Sum of losses in current streak (${h.current} step${h.current===1?'':'s'})`;
  document.getElementById('k_payback').textContent = (h.payback===Infinity ? '∞' : `${h.payback}`);
  document.getElementById('k_paybackmini').textContent = h.avgPos>0 ? `Using avg +${h.avgPos} Return per win` : 'No wins in window — cannot estimate';

  // Policy Hint
  let policy='Within guardrails.';
  if(h.current>=3 || (h.payback!==Infinity && h.payback>2)){
    policy = 'Pause exploration: stop after 3 losses or if Payback > 2×.';
  }else if(h.current>0){
    policy = 'Controlled exploration: losses active — tighten scope and check unit economics.';
  }
  document.getElementById('k_policy').textContent = policy;

  // By category (active only)
  const byCat = lossByCategory(rows);
  document.getElementById('k_losscats').textContent = byCat.length
    ? 'Active loss streaks by category: ' + byCat.map(([c,n])=>`${c} (${n})`).join(' • ')
    : 'Active loss streaks by category: —';

  // subtle pulse for attention
  ['tile_loss','tile_debt','tile_payback','tile_policy'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
  });
}

/* Learning tiles + Calibration + Last-5 */
function renderLearningTiles(rows){
  const total = rows.length;

  const asc = [...rows].sort((a,b)=>a.ts-b.ts);
  const dnavAsc = asc.map(r=>Number(r.dnav)||0);

  const ema7 = dnavAsc.length ? Math.round(ema(dnavAsc,7)) : 0;
  const ema30 = dnavAsc.length ? Math.round(ema(dnavAsc,30)) : 0;
  const momentum = ema7 - ema30;

  const last20 = dnavAsc.slice(-20);
  const consistency = Math.round(stdev(last20));

  let cadence = 0;
  if (asc.length){
    const first = asc[0].ts, last = asc[asc.length-1].ts;
    const days = Math.max(1, (last-first)/86400000);
    cadence = Math.round((total / days) * 7);
  }

  const confs = asc.map(r=>Number(r.confidence)||0);
  const rets  = asc.map(r=>Number(r.return)||0);
  const c = corr(confs,rets);
  const disp = (c===null)?'n/a':(c>=0?'+':'')+(Math.round(c*100)/100);

  const desc = [...rows].sort((a,b)=>b.ts-a.ts);
  const last5 = desc.slice(0,5).map(r=>r.dnav);
  const prior5 = desc.slice(5,10).map(r=>r.dnav);
  const avg = arr => arr.length? Math.round(arr.reduce((a,b)=>a+(Number(b)||0),0)/arr.length) : 0;
  const last5Avg = avg(last5), prior5Avg = avg(prior5);
  const delta5 = last5Avg - prior5Avg;

  animateNumber($('#k_momentum'), momentum);
  animateNumber($('#k_consistency'), consistency);
  animateNumber($('#k_cadence'), cadence);
  $('#k_calib').textContent = disp;
  $('#k_last5').textContent = (delta5>=0?'+':'') + delta5;
  $('#k_last5mini').textContent = `Last-5: ${last5Avg} • Prior-5: ${prior5Avg}`;

  pulse($('#tile_mom')); pulse($('#tile_cons')); pulse($('#tile_cad')); pulse($('#tile_calib')); pulse($('#tile_last5'));
}

function renderStats(allRows){
  const rows = filterRows(allRows);
  const total = rows.length;

  const avg = total ? Math.round(rows.reduce((a,r)=>a + (Number(r.dnav)||0),0)/total) : 0;

  const counts = new Map();
  rows.forEach(r=>{ const c=(r.category||'').trim(); if(!c) return; counts.set(c,(counts.get(c)||0)+1); });
  let topCat='—', topCatCount=0;
  counts.forEach((v,k)=>{ if(v>topCatCount){ topCat=k; topCatCount=v; } });

  const aCounts = new Map();
  rows.forEach(r=>{
    const key=[Math.sign(r.pressure),Math.sign(r.stability),Math.sign(r.return)].join('|');
    const n=oneWord[key]; if(!n) return;
    aCounts.set(n,(aCounts.get(n)||0)+1);
  });
  let topArch='—', topArchCount=0;
  aCounts.forEach((v,k)=>{ if(v>topArchCount){ topArch=k; topArchCount=v; } });

  animateNumber($('#k_total'), total);
  $('#k_recent').textContent = `${total} in range`;
  animateNumber($('#k_avgdnav'), avg);

  pulse($('#tile_total')); pulse($('#tile_avg'));

  $('#k_misc').textContent = `Top category: ${topCat} • Top archetype: ${topArch}`;

  renderAlloc(rows);
  renderDists(rows);
  renderLearningTiles(rows);
  renderLossTiles(rows);
}

function renderLog(){
  const rows=loadLog();
  const tbody=$('#logBody');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${new Date(r.ts).toLocaleString()}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.category||'')}</td>
      <td class="num">${fmt0(r.impact)}</td>
      <td class="num">${fmt0(r.cost)}</td>
      <td class="num">${fmt0(r.risk)}</td>
      <td class="num">${fmt0(r.urgency)}</td>
      <td class="num">${fmt0(r.confidence)}</td>
      <td class="num">${fmt0(r.return)}</td>
      <td class="num">${fmt0(r.pressure)}</td>
      <td class="num">${fmt0(r.stability)}</td>
      <td class="num" style="font-weight:700;">${fmt0(r.dnav)}</td>
      <td style="text-align:center;">
        <button data-idx="${i}" class="del" style="border:0;background:transparent;color:#fff;cursor:pointer;">✕</button>
      </td>
    </tr>
  `).join('');

  tbody.querySelectorAll('button.del').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const idx=Number(btn.getAttribute('data-idx'));
      const arr=loadLog(); arr.splice(idx,1); saveLog(arr); renderLog(); populateRecent();
    });
  });

  renderStats(rows);
}

/* Form + log */
function resetForm(){
  SLIDER_IDS.forEach(id=>{ const el=$('#'+id); el.value=1; });
  $('#decisionName').value='';
  $('#decisionCategory').value='';
  compute();
  $('#enterBtn').disabled = true;
}
function checkFormValid(){
  const nameOk = $('#decisionName').value.trim().length>0;
  const catOk  = $('#decisionCategory').value.trim().length>0;
  $('#enterBtn').disabled = !(nameOk && catOk);
}
function enterDecision(){
  const btn=$('#enterBtn'); if(btn.disabled) return;
  btn.disabled = true;
  const name=$('#decisionName').value.trim();
  const category=$('#decisionCategory').value.trim();
  if(!name || !category){ btn.disabled=false; return; }

  const vals=readCurrent();
  const m=computeMetrics(vals);

  const row={
    ts:Date.now(),
    name, category,
    ...vals,
    return:m.ret, pressure:m.pressure, stability:m.stability, merit:m.merit, energy:m.energy, dnav:m.dnav
  };

  const arr=loadLog();
  arr.unshift(row);
  saveLog(arr);

  // Decrement aggressive window if used on a pressured (positive) return
  const {on, left} = getAggressiveState();
  if(on && left>0){
    const press = vals.urgency - vals.confidence;
    const ret   = vals.impact - vals.cost;
    if(press>0 && press<=2 && ret>=0){
      setAggressiveLeft(left-1);
    }
  }

  renderLog();
  resetForm();
}

/* ---- Upload UI wiring ---- */
const csvInput  = document.getElementById('csvInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadMsg = document.getElementById('uploadMsg');

function setUploadMsg(text, ok=false){
  uploadMsg.textContent = text;
  uploadMsg.style.color = ok ? '#9fe7b6' : '#ffb3b3';
}

let selectedFile = null;
csvInput.addEventListener('change', ()=>{
  selectedFile = (csvInput.files && csvInput.files[0]) ? csvInput.files[0] : null;
  uploadBtn.disabled = !selectedFile;
  setUploadMsg(selectedFile ? `Selected: ${selectedFile.name}. Click “Confirm Import”.` : '');
});
uploadBtn.addEventListener('click', async ()=>{
  if(!selectedFile){ setUploadMsg('Please choose a CSV first.'); return; }
  try{
    const text = await selectedFile.text();
    const res = importCSV(text);
    setUploadMsg(`Imported ${res.count} row${res.count!==1?'s':''}.`, true);
    renderLog();
    csvInput.value = '';
    selectedFile = null;
    uploadBtn.disabled = true;
  }catch(err){
    setUploadMsg(`Import failed: ${err.message||err}`);
  }
});

/* ======== Compare modal: multi-scenario + base lock/unlock ======== */
const compareModal = document.getElementById('compareModal');
const openCompareFab = document.getElementById('openCompareFab');
const openCompareBtnA = document.getElementById('openCompareBtnA');
const closeCompareBtn = document.getElementById('closeCompareBtn');
const recentSelect = document.getElementById('recentSelect');
const moreBtn = document.getElementById('moreRecentBtn');
const morePanel = document.getElementById('morePanel');
const moreClose = document.getElementById('moreClose');
const moreList = document.getElementById('moreList');
const addScenarioBtn = document.getElementById('addScenarioBtn');
const baseLock = document.getElementById('baseLock');
const baseLockState = document.getElementById('baseLockState');
const scenariosWrap = document.getElementById('scenarios');
const winnerTag = document.getElementById('winnerTag');
const winnerLine = document.getElementById('winnerLine');

const scenarioPalette = ['#4cc9f0','#f72585','#b5179e','#7209b7','#3f37c9','#4895ef','#06d6a0','#ffd166','#ef476f','#8338ec','#ff006e','#3a86ff'];
let scenarioCount = 0;
const scenarios = new Map();
let baseOverride = null;

/* Simple mode labels */
const SIMPLE_LABELS = {
  impact:   {label:'Upside',     hint:'How big the win could be'},
  cost:     {label:'Price',      hint:'Money/time/effort it takes'},
  risk:     {label:'Could go wrong', hint:'Chance + size of downside'},
  urgency:  {label:'How soon',   hint:'How quickly this matters'},
  confidence:{label:'How sure',  hint:'Evidence and readiness'}
};
function setSimpleMode(on){
  // Global first card labels
  const firstCard = document.querySelector('.wrap .card');
  if(firstCard){
    const rows = firstCard.querySelectorAll('.row');
    const keys = ['impact','cost','risk','urgency','confidence'];
    keys.forEach((k,i)=>{
      const L = rows[i]?.querySelector('.label-main');
      const H = rows[i]?.querySelector('.hint');
      if(L && H){
        const defLabel = L.getAttribute('data-default') || L.textContent;
        const defHint  = H.getAttribute('data-default') || H.textContent;
        if(!L.getAttribute('data-default')) L.setAttribute('data-default', defLabel);
        if(!H.getAttribute('data-default')) H.setAttribute('data-default', defHint);
        L.textContent = on ? SIMPLE_LABELS[k].label : L.getAttribute('data-default');
        H.textContent = on ? SIMPLE_LABELS[k].hint  : H.getAttribute('data-default');
      }
    });
  }
  // Scenario cards
  document.querySelectorAll('.sc-card').forEach(card=>{
    const defs = {
      impact:{lab:'Impact', hint:'↑ Payoff'},
      cost:{lab:'Cost', hint:'↓ Unit cost'},
      risk:{lab:'Risk', hint:'↓ Downside'},
      urgency:{lab:'Urgency', hint:'↑ Speed'},
      confidence:{lab:'Confidence', hint:'↑ Evidence'},
    };
    Object.keys(defs).forEach(k=>{
      const row = card.querySelector(`.row input[data-field="${k}"]`)?.closest('.row');
      if(!row) return;
      const lab = row.querySelector('.label-main');
      const hint = row.querySelector('.hint');
      if(lab && hint){
        lab.textContent  = on ? SIMPLE_LABELS[k].label : defs[k].lab;
        hint.textContent = on ? SIMPLE_LABELS[k].hint  : defs[k].hint;
      }
    });
  });
}
document.getElementById('simpleMode')?.addEventListener('change', (e)=> setSimpleMode(e.target.checked));

function populateRecent(){
  const rows = loadLog().slice(0,5);
  const prev = recentSelect.value;
  recentSelect.innerHTML = '<option value="">Load from recent…</option>';
  rows.forEach((r,idx)=>{
    const label = `${new Date(r.ts).toLocaleString()} — ${r.name} (${r.category})`;
    const opt = document.createElement('option');
    opt.value = String(idx);
    opt.textContent = label;
    recentSelect.appendChild(opt);
  });
  recentSelect.value = prev && recentSelect.querySelector(`option[value="${prev}"]`) ? prev : '';
}
function populateMorePanel(){
  const rows = loadLog();
  if(!rows.length){ moreList.innerHTML = '<div class="muted">No saved decisions yet.</div>'; return; }
  moreList.innerHTML = rows.map((r,idx)=>`
    <div class="more-row" data-idx="${idx}">
      <div><b>${escapeHtml(r.name||'—')}</b> <span class="muted">(${escapeHtml(r.category||'—')})</span></div>
      <div class="muted" style="font-size:12px">${new Date(r.ts).toLocaleString()} • I:${r.impact} C:${r.cost} R:${r.risk} U:${r.urgency} Conf:${r.confidence}</div>
    </div>
  `).join('');
  moreList.querySelectorAll('.more-row').forEach(row=>{
    row.addEventListener('click', ()=>{
      const r = loadLog()[Number(row.getAttribute('data-idx'))];
      if(!r) return;
      const lastKey = Array.from(scenarios.keys()).pop();
      if(lastKey){
        setScenarioValues(lastKey,{impact:r.impact,cost:r.cost,risk:r.risk,urgency:r.urgency,confidence:r.confidence});
        recomputeScenario(lastKey);
      }
      morePanel.style.display='none';
    });
  });
}

function openCompare(){
  if(compareModal.getAttribute('aria-hidden')==='false') return;
  populateRecent();
  updateBaseInModal();
  clearScenarios();
  addScenario();
  compareModal.classList.add('show');
  compareModal.setAttribute('aria-hidden','false');
  document.body.classList.add('no-scroll');
  renderDeltaBoard();
}
function closeCompare(){
  compareModal.classList.remove('show');
  compareModal.setAttribute('aria-hidden','true');
  document.body.classList.remove('no-scroll');
}
openCompareFab.addEventListener('click', openCompare);
openCompareBtnA.addEventListener('click', openCompare);
closeCompareBtn.addEventListener('click', closeCompare);
compareModal.addEventListener('click', (e)=>{ if(e.target===compareModal) closeCompare(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && compareModal.getAttribute('aria-hidden')==='false') closeCompare(); });

moreBtn.addEventListener('click', ()=>{
  populateMorePanel();
  morePanel.style.display = (morePanel.style.display==='block' ? 'none' : 'block');
});
moreClose.addEventListener('click', ()=>{ morePanel.style.display='none'; });

recentSelect.addEventListener('change', ()=>{
  const idx = Number(recentSelect.value);
  if(Number.isFinite(idx)){
    const r = loadLog()[idx];
    if(r){ addScenario({impact:r.impact,cost:r.cost,risk:r.risk,urgency:r.urgency,confidence:r.confidence}); }
    recentSelect.value = '';
  }
});

baseLock.addEventListener('change', ()=>{
  baseLockState.textContent = baseLock.checked?'(locked)':'(unlocked)';
  if(!baseLock.checked && baseOverride==null){ baseOverride = {...readCurrent()}; }
  updateBaseInModal(); recomputeAllScenarios();
});

/* Aggressive controls wiring */
document.getElementById('aggrOn').addEventListener('change', ()=>{
  const {on, cap} = {on:document.getElementById('aggrOn').checked, cap:Number(document.getElementById('aggrN').value||0)};
  if(on){ setAggressiveLeft(Number(localStorage.getItem('dnav_aggr_left') ?? cap)); }
  compute();
});
document.getElementById('aggrN').addEventListener('input', ()=>{
  const n = Number(document.getElementById('aggrN').value||0);
  setAggressiveLeft(n);
  compute();
});

function updateBaseInModal(){
  const base = baseLock.checked ? readCurrent() : (baseOverride || readCurrent());
  const Mb = computeMetrics(base);
  document.getElementById('B_meta').textContent = `I:${base.impact}  C:${base.cost}  R:${base.risk}  U:${base.urgency}  Conf:${base.confidence}`;
  document.getElementById('B_ret').textContent = (Mb.ret>=0?'+':'')+Mb.ret;
  document.getElementById('B_stab').textContent = (Mb.stability>=0?'+':'')+Mb.stability;
  document.getElementById('B_press').textContent = (Mb.pressure>=0?'+':'')+Mb.pressure;
  document.getElementById('B_dnav').textContent = Mb.dnav;
  const baseCoach = coachHint({ret:Mb.ret, stab:Mb.stability, press:Mb.pressure, urg: base.urgency, conf: base.confidence, impact: base.impact, cost: base.cost, risk: base.risk});
  document.getElementById('B_tldr').textContent = `Base: ${baseCoach}`;
  renderDeltaBoard();
}

/* Scenario helpers */
function clearScenarios(){ scenarios.clear(); scenariosWrap.innerHTML=''; scenarioCount=0; winnerTag.textContent='—'; winnerTag.className='win'; winnerLine.textContent='Add/tweak scenarios to see which option leads on D-NAV.'; }

function addScenario(seedVals){
  const key = `S${++scenarioCount}`;
  const hue = scenarioPalette[(scenarioCount-1)%scenarioPalette.length];
  const card = document.createElement('div');
  card.className='sc-card';
  card.id = `card_${key}`;
  card.innerHTML = `
    <div class="sc-head">
      <div style="display:flex;align-items:center;gap:6px;">
        <span class="sc-hue" style="background:${hue}"></span>
        <b>Scenario ${key}</b>
      </div>
      <div class="sc-footer">
        <button class="closeX" data-act="setbase">Set as Base</button>
        <button class="closeX" data-act="reset">Reset</button>
        <button class="closeX" data-act="remove">Remove</button>
      </div>
    </div>
    <div class="row"><label><span class="label-main">Impact</span><span class="hint">↑ Payoff</span></label><input type="range" min="1" max="10" value="1" data-k="${key}" data-field="impact"/><output id="${key}_o_impact">1</output></div>
    <div class="row"><label><span class="label-main">Cost</span><span class="hint">↓ Unit cost</span></label><input type="range" min="1" max="10" value="1" data-k="${key}" data-field="cost"/><output id="${key}_o_cost">1</output></div>
    <div class="row"><label><span class="label-main">Risk</span><span class="hint">↓ Downside</span></label><input type="range" min="1" max="10" value="1" data-k="${key}" data-field="risk"/><output id="${key}_o_risk">1</output></div>
    <div class="row"><label><span class="label-main">Urgency</span><span class="hint">↑ Speed</span></label><input type="range" min="1" max="10" value="1" data-k="${key}" data-field="urgency"/><output id="${key}_o_urgency">1</output></div>
    <div class="row"><label><span class="label-main">Confidence</span><span class="hint">↑ Evidence</span></label><input type="range" min="1" max="10" value="1" data-k="${key}" data-field="confidence"/><output id="${key}_o_confidence">1</output></div>

    <div class="kpis" style="margin-top:6px;">
      <div class="kpi"><h4>Return</h4><div class="big" id="${key}_ret">0</div></div>
      <div class="kpi"><h4>Stability</h4><div class="big" id="${key}_stab">0</div></div>
      <div class="kpi"><h4>Pressure</h4><div class="big" id="${key}_press">0</div></div>
      <div class="kpi"><h4>D-NAV</h4><div class="big" id="${key}_dnav">0</div></div>
    </div>

    <div class="delta" style="margin-top:6px;">
      <div class="tile"><h4>Δ Return</h4><div class="big" id="${key}_Dret">0</div></div>
      <div class="tile"><h4>Δ Stability</h4><div class="big" id="${key}_Dstab">0</div></div>
      <div class="tile"><h4>Δ Pressure</h4><div class="big" id="${key}_Dpress">0</div></div>
      <div class="tile"><h4>Δ D-NAV</h4><div class="big" id="${key}_Ddnav">0</div></div>
    </div>

    <div class="card" style="margin-top:6px;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.1)">
      <h3 style="margin:0 0 6px 0;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase;font-size:12px;">Objective</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <select id="${key}_obj" class="input" style="padding:6px 8px;">
          <option value="max_dnav">Maximize D-NAV</option>
          <option value="max_return">Maximize Return</option>
          <option value="min_pressure">Minimize Pressure</option>
          <option value="hit_stability">Hit Stability ≥ target</option>
        </select>
        <span class="muted">Target:</span>
        <input id="${key}_stabTarget" type="range" min="-5" max="9" value="0" />
        <output id="${key}_stabOut">0</output>
        <button class="cta" data-act="nudge">Find easiest single change</button>
      </div>
      <div class="knob" id="${key}_knob">Pick an objective to get a suggested change.</div>
    </div>
  `;
  scenariosWrap.appendChild(card);
  scenarios.set(key,{impact:1,cost:1,risk:1,urgency:1,confidence:1, hue});

  setScenarioValues(key, seedVals || readCurrent());
  recomputeScenario(key);

  card.querySelectorAll('input[type=range][data-k="'+key+'"]').forEach(el=>{
    el.addEventListener('input', ()=>{
      const field=el.getAttribute('data-field');
      const v = Math.max(1, Math.min(10, Number(el.value||1)));
      scenarios.get(key)[field]=v;
      document.getElementById(`${key}_o_${field}`).textContent=v;
      recomputeScenario(key);
    });
  });

  card.querySelectorAll('button').forEach(btn=>{
    const act = btn.getAttribute('data-act');
    if(act==='remove'){
      btn.addEventListener('click', ()=>{ scenarios.delete(key); card.remove(); recomputeAllScenarios(); });
    }
    if(act==='reset'){
      btn.addEventListener('click', ()=>{ setScenarioValues(key,{impact:1,cost:1,risk:1,urgency:1,confidence:1}); recomputeScenario(key); });
    }
    if(act==='setbase'){
      btn.addEventListener('click', ()=>{
        if(baseLock.checked){ alert('Unlock Base first.'); return; }
        baseOverride = {...scenarios.get(key)};
        updateBaseInModal(); recomputeAllScenarios();
      });
    }
    if(act==='nudge'){
      btn.addEventListener('click', ()=>{ suggestNudgeForScenario(key); });
    }
  });

  const st = document.getElementById(`${key}_stabTarget`);
  const so = document.getElementById(`${key}_stabOut`);
  st.addEventListener('input',()=>{ so.textContent = st.value; });

  // Respect current Simple Mode state for new cards
  const simpleOn = document.getElementById('simpleMode')?.checked;
  if(simpleOn) setSimpleMode(true);
}

addScenarioBtn.addEventListener('click', ()=> addScenario());

function setScenarioValues(key, vals){
  const s = scenarios.get(key); if(!s) return;
  const fields=['impact','cost','risk','urgency','confidence'];
  fields.forEach(f=>{
    const v = Math.max(1, Math.min(10, Number(vals?.[f]??1)));
    s[f]=v;
    const el = document.querySelector(`#card_${key} input[data-field="${f}"]`);
    if(el){ el.value=v; document.getElementById(`${key}_o_${f}`).textContent=v; }
  });
}

function recomputeScenario(key){
  const base = baseLock.checked ? readCurrent() : (baseOverride || readCurrent());
  const Bm = computeMetrics(base);
  const s = scenarios.get(key); if(!s) return;
  const M = computeMetrics(s);

  ['ret','stab','press','dnav'].forEach(k=>{
    const map = { ret: 'ret', stab: 'stability', press: 'pressure', dnav: 'dnav' };
    const val = M[map[k]];
    document.getElementById(`${key}_${k}`).textContent = (k === 'dnav')
      ? val
      : ((val >= 0 ? '+' : '') + val);
  });

  const d = {
    ret: M.ret - Bm.ret,
    stab: M.stability - Bm.stability,
    press: M.pressure - Bm.pressure,
    dnav: M.dnav - Bm.dnav
  };
  document.getElementById(`${key}_Dret`).textContent  = (d.ret>=0?'+':'')+d.ret;
  document.getElementById(`${key}_Dstab`).textContent = (d.stab>=0?'+':'')+d.stab;
  document.getElementById(`${key}_Dpress`).textContent = (d.press>=0?'+':'')+d.press;
  document.getElementById(`${key}_Ddnav`).textContent = (d.dnav>=0?'+':'')+d.dnav;

  recomputeWinner();
}

function recomputeAllScenarios(){ scenarios.forEach((_v,k)=>recomputeScenario(k)); }

function recomputeWinner(){
  let bestKey=null, best= -Infinity;
  const base = baseLock.checked ? readCurrent() : (baseOverride || readCurrent());
  const Bm = computeMetrics(base);
  scenarios.forEach((s,k)=>{
    const M = computeMetrics(s);
    const delta = M.dnav - Bm.dnav;
    if(delta>best){ best=delta; bestKey=k; }
  });
  if(bestKey){
    winnerTag.textContent = `${bestKey} leads`;
    winnerTag.className='win a';
    winnerLine.textContent = `${bestKey} ahead by ${best>=0?'+':''}${best} D-NAV vs Base.`;
  }else{
    winnerTag.textContent='—'; winnerTag.className='win'; winnerLine.textContent='Add/tweak scenarios to see which option leads on D-NAV.';
  }
  renderDeltaBoard();
}

/* ---- Delta Board (Base-side visual table) ---- */
function arrowCls(n){ return n>0?'up':(n<0?'down':'flat'); }
function arrowTxt(n){ return n>0?'▲':(n<0?'▼':'–'); }
function renderDeltaBoard(){
  const board = document.getElementById('deltaBoard');
  const tbody = document.querySelector('#deltaTable tbody');
  if(!tbody) return;

  const base = (document.getElementById('baseLock').checked ? readCurrent() : (baseOverride || readCurrent()));
  const Bm = computeMetrics(base);

  const rows=[];
  scenarios.forEach((s,k)=>{
    const M = computeMetrics(s);
    rows.push({
      key:k,
      dret: M.ret - Bm.ret,
      dstab: M.stability - Bm.stability,
      dpress: M.pressure - Bm.pressure,
      ddnav: M.dnav - Bm.dnav
    });
  });

  if(!rows.length){ board.style.display='none'; tbody.innerHTML=''; return; }
  board.style.display='block';

  const maxAbs = Math.max(1, ...rows.map(r=>Math.abs(r.ddnav)));
  tbody.innerHTML = rows.map(r=>{
    const width = Math.round(Math.min(100, Math.abs(r.ddnav)/maxAbs*100));
    const pos = r.ddnav>=0;
    return `
      <tr>
        <td style="font-weight:800">${r.key}</td>
        <td><span class="arrow ${arrowCls(r.dret)}">${arrowTxt(r.dret)}</span> ${(r.dret>=0?'+':'')}${r.dret}</td>
        <td><span class="arrow ${arrowCls(r.dstab)}">${arrowTxt(r.dstab)}</span> ${(r.dstab>=0?'+':'')}${r.dstab}</td>
        <td><span class="arrow ${arrowCls(r.dpress)}">${arrowTxt(r.dpress)}</span> ${(r.dpress>=0?'+':'')}${r.dpress}</td>
        <td>
          <div class="barchip">
            <span class="${pos?'pos':'neg'}" style="width:${width}%"></span>
          </div>
          <div style="font-size:11px;margin-top:2px;text-align:right">${(r.ddnav>=0?'+':'')}${r.ddnav}</div>
        </td>
      </tr>
    `;
  }).join('');
}

/* ---- Nudge finder ---- */
function suggestNudgeForScenario(key){
  const base = (document.getElementById('baseLock').checked ? readCurrent() : (baseOverride || readCurrent()));
  const Bm = computeMetrics(base);
  const s = scenarios.get(key); if(!s) return;
  const M0 = computeMetrics(s);
  const obj = document.getElementById(`${key}_obj`).value;
  const targetStab = Number(document.getElementById(`${key}_stabTarget`).value);

  const levers = [
    {k:'impact', dir:+1, label:'Impact'},
    {k:'cost',   dir:-1, label:'Cost'},
    {k:'risk',   dir:-1, label:'Risk'},
    {k:'urgency',dir:+1, label:'Urgency'},
    {k:'confidence',dir:+1,label:'Confidence'},
  ];

  function meets(M){
    if(obj==='max_dnav')      return M.dnav >= Math.max(Bm.dnav, M0.dnav);
    if(obj==='max_return')    return M.ret  >= Math.max(Bm.ret,  M0.ret);
    if(obj==='min_pressure')  return M.pressure <= Math.min(Bm.pressure, M0.pressure);
    if(obj==='hit_stability') return M.stability >= targetStab;
    return false;
  }
  function primary(M){
    if(obj==='max_dnav')      return M.dnav - Math.max(Bm.dnav, M0.dnav);
    if(obj==='max_return')    return M.ret  - Math.max(Bm.ret,  M0.ret);
    if(obj==='min_pressure')  return Math.min(Bm.pressure, M0.pressure) - M.pressure;
    if(obj==='hit_stability') return M.stability - targetStab;
    return -Infinity;
  }

  const cands = [];
  for(const L of levers){
    const start = s[L.k];
    for(let pct=1; pct<=50; pct++){
      const delta = start * (pct/100) * L.dir;
      let trialVal = Math.min(10, Math.max(1, start + delta));
      trialVal = Math.round(trialVal); // match slider ticks
      if(trialVal === start) continue;
      const Mt = computeMetrics({...s, [L.k]: trialVal});
      if(meets(Mt)){
        cands.push({
          lever:L, pct,
          ticks: Math.abs(trialVal - start),
          before:start, after:trialVal,
          Mt, lift: primary(Mt),
          dnavLift: Mt.dnav - M0.dnav
        });
        break; // smallest change for this lever
      }
    }
  }

  const knobLine = document.getElementById(`${key}_knob`);
  if(!cands.length){
    knobLine.textContent = 'I tried 1–50% on each slider. No single change hits the goal. Try combining two sliders.';
    return;
  }

  cands.sort((a,b)=>{
    if(a.ticks!==b.ticks) return a.ticks-b.ticks;
    if(a.pct!==b.pct) return a.pct-b.pct;
    if(a.lift!==b.lift) return b.lift-a.lift;
    return b.dnavLift-a.dnavLift;
  });
  const best = cands[0];

  const fmt = n => (n>=0?'+':'')+n;
  knobLine.textContent =
    `Easiest single change: ${best.lever.label} from ${best.before} → ${best.after} (${best.pct}% ≈ ${best.ticks} tick${best.ticks!==1?'s':''}). `
    + `Result: D-NAV ${best.Mt.dnav} • Return ${fmt(best.Mt.ret)} • Stability ${fmt(best.Mt.stability)} • Pressure ${fmt(best.Mt.pressure)}. `
    + `How this works: I test each slider by 1–50% and pick the smallest change that clears your goal.`;
}

/* Buttons + handlers */
document.getElementById('decisionName').addEventListener('input', checkFormValid);
document.getElementById('decisionCategory').addEventListener('input', checkFormValid);
document.getElementById('enterBtn').addEventListener('click', enterDecision);
document.getElementById('downloadCsvBtn').addEventListener('click', downloadCsv);
document.getElementById('downloadPdfBtn').addEventListener('click', openPdfReport);
document.getElementById('clearLogBtn').addEventListener('click', ()=>{
  if(confirm('Clear all saved decisions?')){ saveLog([]); renderLog(); populateRecent(); }
});

/* Keep sliders live */
["impact","cost","risk","urgency","confidence"].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', compute);
  el.addEventListener('change', compute);
});

/* Range select re-renders stats + affects PDF window */
document.getElementById('rangeSelect').addEventListener('change', ()=>renderStats(loadLog()));

/* Compare openers */
function safeBind(el, fn){ if(el) el.addEventListener('click', fn); }
safeBind(document.getElementById('openCompareFab'), openCompare);
safeBind(document.getElementById('openCompareBtnA'), openCompare);

/* boot */
document.getElementById('allocTitle').textContent = 'Drive (U×C) by category';
setAggressiveLeft(Number(localStorage.getItem('dnav_aggr_left') ?? (document.getElementById('aggrN').value || 0)));
compute();
renderLog();

/* Accessibility: close More panel on outside click */
document.addEventListener('click',(e)=>{
  const morePanel = document.getElementById('morePanel');
  const moreBtn = document.getElementById('moreRecentBtn');
  const within = morePanel.contains(e.target) || e.target===moreBtn;
  if(!within){ morePanel.style.display='none'; }
});
</script>
</body>
</html>
