<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>D-NAV Mini — Sliders Demo (v3.8)</title>
<style>
:root{--bg:#0b0f14;--card:#121821;--muted:#8fa1b7;--text:#e9eef5;--green:#3ecf8e;--red:#ff6b6b;--amber:#f3b431;--blue:#69a9ff}
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{background:var(--bg);color:var(--text);margin:0;padding:24px}
.wrap{max-width:1200px;margin:0 auto;display:grid;gap:16px;grid-template-columns:1fr 1fr 1fr}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
h1{margin:0 0 8px;font-weight:800;font-size:22px;letter-spacing:.2px}
.row{display:grid;grid-template-columns:110px 1fr 52px;gap:10px;align-items:center;margin:8px 0 14px}
.row label{font-weight:700;color:#d7e2ef;font-size:16px}
input[type=range]{width:100%;height:32px}
output{text-align:right;display:inline-block;min-width:40px;font-weight:800;font-size:16px}
.muted{color:var(--muted);font-size:13px}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.stats{display:grid;grid-template-rows:repeat(3,1fr);gap:12px}
.stat{background:rgba(255,255,255,.04);border-radius:12px;padding:14px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between}
.stat h3{margin:0;font-size:12px;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase}
.val{font-size:36px;font-weight:900;line-height:1.1}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
.green{background:rgba(62,207,142,.18);color:var(--green);border:1px solid rgba(62,207,142,.4)}
.amber{background:rgba(243,180,49,.18);color:var(--amber);border:1px solid rgba(243,180,49,.35)}
.red{background:rgba(255,107,107,.18);color:var(--red);border:1px solid rgba(255,107,107,.4)}
.summary{display:grid;grid-template-rows:auto auto 1fr;gap:12px}
.arch h3,.comp h3,.coach h3{margin:0;font-size:12px;color:#9fb1c7;text-transform:uppercase;letter-spacing:.3px}
.arch .name{font-size:26px;font-weight:900;margin-top:6px}.arch .desc{color:#c9d4e6;margin-top:6px}
.comp .big{font-size:44px;font-weight:900;margin-top:6px}.comp .tag{margin-top:4px;font-size:12px;color:#a7b4c7}
.coach .txt{margin-top:6px;color:#c9d4e6;line-height:1.55}

/* Entry & Log */
.grid{display:grid;gap:12px}
.input{padding:10px;border:1px solid #333;border-radius:10px;background:#0f141b;color:var(--text)}
.btn{padding:12px 16px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn.secondary{background:#0f141b;border:1px solid #444}
.table-wrap{overflow:auto;border:1px solid #222;border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px}
thead{background:#0d0d0d;color:#fff}
tr+tr{border-top:1px solid #1e1e1e}

/* numeric alignment for table */
.num{
  text-align:right;
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}
tbody tr:nth-child(even){ background: rgba(255,255,255,.02); }

/* === Stats HUD tiles === */
.kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:10px}
.kpi{background:rgba(255,255,255,.04);border-radius:12px;padding:12px 14px;position:relative}
.kpi h4{margin:0;font-size:12px;color:#9fb1c7;letter-spacing:.3px;text-transform:uppercase}
.kpi .big{font-size:28px;font-weight:900;margin-top:6px}
.mini{font-size:12px;color:#a7b4c7;margin-top:4px}
.progress{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px}
.progress>span{display:block;height:100%;transition:width .45s ease}

/* Energy allocation list */
.alloc{margin-top:12px}
.alloc .row{display:grid;grid-template-columns:160px 1fr 260px;gap:12px;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.alloc .row:last-child{border-bottom:none}
.alloc .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
.alloc .bar>span{display:block;height:100%;background:var(--blue);transition:width .45s ease}
.alloc .meta{font-size:12px;color:#a7b4c7;text-align:right}

/* pulse highlight when numbers update */
@keyframes pulse-kpi{0%{box-shadow:0 0 0 0 rgba(105,169,255,.35)}100%{box-shadow:0 0 0 14px rgba(105,169,255,0)}}
.kpi.pulse{animation:pulse-kpi .6s ease}

@media (max-width:900px){
  body{padding:14px}
  .wrap{grid-template-columns:1fr}
  .row{grid-template-columns:90px 1fr 46px}
  h1{font-size:20px}
  .val{font-size:32px}
  .comp .big{font-size:38px}
  input[type=range]{height:36px}
  .kpis{grid-template-columns:1fr 1fr}
  .alloc .row{grid-template-columns:1fr}
  .alloc .meta{text-align:left}
}
</style></head>
<body>
<div class="wrap">
  <div class="card">
    <h1>D-NAV Mini — Sliders Demo</h1>
    <div class="muted">Move the 5 sliders (1–10). Right side updates live with Return, Stability, Pressure → Archetype → Composite → Coach readout.</div>
    <!-- Default all sliders to 1 -->
    <div class="row"><label>Impact</label><input id="impact" type="range" min="1" max="10" value="1" /><output id="o_impact">1</output></div>
    <div class="row"><label>Cost</label><input id="cost" type="range" min="1" max="10" value="1" /><output id="o_cost">1</output></div>
    <div class="row"><label>Risk</label><input id="risk" type="range" min="1" max="10" value="1" /><output id="o_risk">1</output></div>
    <div class="row"><label>Urgency</label><input id="urgency" type="range" min="1" max="10" value="1" /><output id="o_urgency">1</output></div>
    <div class="row"><label>Confidence</label><input id="confidence" type="range" min="1" max="10" value="1" /><output id="o_confidence">1</output></div>
    <div class="muted">Formula: <span class="mono">(Impact − Cost − Risk) + (Urgency × Confidence)</span></div>
  </div>

  <div class="card stats">
    <div class="stat"><h3>Return</h3><div class="val" id="ret">0</div><span id="retPill" class="pill amber">Neutral</span></div>
    <div class="stat"><h3>Stability</h3><div class="val" id="stab">0</div><span id="stabPill" class="pill amber">Neutral</span></div>
    <div class="stat"><h3>Pressure</h3><div class="val" id="press">0</div><span id="pressPill" class="pill amber">Balanced</span></div>
  </div>

  <div class="card summary">
    <div class="arch"><h3>Archetype</h3><div id="arch" class="name">Routine Play</div><div id="archDesc" class="desc">Everyday operation — safe, predictable, not transformative.</div></div>
    <div class="comp"><h3>Composite (Energy)</h3><div id="score" class="big">0</div><div id="scoreTag" class="tag">Low energy</div></div>
    <div class="coach"><h3>Coach Readout</h3><div id="coach" class="txt">Greenlight profile — execute with discipline.</div></div>
  </div>
</div>

<!-- ENTRY -->
<div class="wrap" style="grid-template-columns:1fr;">
  <div class="card grid">
    <h2 style="margin:0;">Quick Entry</h2>
    <input id="decisionName" class="input" type="text" placeholder="Decision name (e.g., ‘Investor meetup solo’)" />
    <input id="decisionCategory" class="input" type="text" placeholder="Category (e.g., Career, Health, Relationships)" />
    <button id="enterBtn" class="btn" disabled>Enter decision</button>
    <div class="muted">Fill name & category, set sliders → click <b>Enter decision</b>. Stored on this device.</div>
  </div>
</div>

<!-- STATS HUD -->
<div class="wrap" style="grid-template-columns:1fr;">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <h2 style="margin:0;">Your Decision Stats</h2>
      <select id="rangeSelect" class="input" style="width:160px;padding:8px 10px;">
        <option value="0">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
      </select>
    </div>
    <div class="kpis">
      <div class="kpi" id="tile_total">
        <h4>Decisions</h4>
        <div class="big" id="k_total" data-val="0">0</div>
        <div class="mini" id="k_recent">(0 in range)</div>
      </div>
      <div class="kpi" id="tile_avg">
        <h4>Avg D-NAV</h4>
        <div class="big" id="k_avgdnav" data-val="0">0</div>
        <div class="mini">Composite (Merit + Drive)</div>
      </div>
      <div class="kpi" id="tile_pos">
        <h4>Positive Return</h4>
        <div class="big" id="k_posret" data-val="0">0%</div>
        <div class="progress"><span id="bar_posret" style="width:0%;background:var(--green)"></span></div>
      </div>
      <div class="kpi" id="tile_stable">
        <h4>Stable</h4>
        <div class="big" id="k_stable" data-val="0">0%</div>
        <div class="progress"><span id="bar_stable" style="width:0%;background:var(--green)"></span></div>
      </div>
      <div class="kpi" id="tile_press">
        <h4>Pressured</h4>
        <div class="big" id="k_pressured" data-val="0">0%</div>
        <div class="progress"><span id="bar_press" style="width:0%;background:var(--red)"></span></div>
      </div>
    </div>

    <h3 id="allocTitle" style="margin:14px 0 6px;">Attention (U×C) by category</h3>
    <div class="alloc" id="allocList"></div>

    <div class="mini" id="k_misc" style="margin-top:8px;">Top category: — • Top archetype: —</div>
  </div>
</div>

<!-- LOG -->
<div class="wrap" style="grid-template-columns:1fr;">
  <div class="card grid">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
      <h2 style="margin:0;">Decision Log</h2>
      <div style="display:flex;gap:8px;">
        <button id="downloadCsvBtn" class="btn secondary">Download CSV</button>
        <button id="clearLogBtn" class="btn secondary">Clear</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="logTable">
        <thead>
          <tr>
            <th>When</th>
            <th>Name</th>
            <th>Category</th>
            <th style="text-align:right;">Impact</th>
            <th style="text-align:right;">Cost</th>
            <th style="text-align:right;">Risk</th>
            <th style="text-align:right;">Urgency</th>
            <th style="text-align:right;">Confidence</th>
            <th style="text-align:right;">Return</th>
            <th style="text-align:right;">Pressure</th>
            <th style="text-align:right;">Stability</th>
            <th style="text-align:right;">D-NAV</th>
            <th style="text-align:center;">✕</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- CTA cards -->
<div style="width:100%;height:80px;margin-top:16px;display:flex;align-items:center;" class="card wrap">
  <a target="_blank" rel="noopener noferrer" href="https://decisionnavigator.gumroad.com/?_gl=1*p1viyp*_ga*MTc5ODg3MDQ3MC4xNzU5MjYxMjk3*_ga_6LJN6D94N6*czE3NTk0MjQ5MDEkbzMkZzAkdDE3NTk0MjQ5MDEkajYwJGwwJGgw">
    Start tracking all of your decisions here
  </a>
</div>

<div style="width:100%;height:80px;margin-top:16px;display:flex;align-items:center;" class="card wrap">
  <a href="/definitions.html" style="cursor:pointer;height:full;text-align:center;display:flex;align-items:center;color:white">
    View Archetype definitions here
  </a>
</div>

<div style="display:flex;flex:1;justify-content:center;align-items:center;margin-top:16px;">
  <img src="./logo.PNG" style="background-color:#c9d4e6;width:100px;height:100px;border-radius:8px;" />
</div>

<script>
/* --- Archetypes and descriptions --- */
const names={
"1|1|1":"Urgent Jackpot","1|1|0":"Stable Grind","1|1|-1":"Overconfident Burn",
"1|0|1":"Calculated Sprint","1|0|0":"Fire Drill","1|0|-1":"Stress Spiral",
"1|-1|1":"Chaos Bet","1|-1|0":"Tenuous Push","1|-1|-1":"Chaos Burn",
"0|1|1":"Strategic Patience","0|1|0":"Maintenance Mode","0|1|-1":"Comfortable Decline",
"0|0|1":"Balanced Growth","0|0|0":"Routine Play","0|0|-1":"Stagnant Drift",
"0|-1|1":"Fragile Moonshot","0|-1|0":"Wobbly Venture","0|-1|-1":"Dead End",
"-1|1|1":"Calm Jackpot","-1|1|0":"Comfort Zone","-1|1|-1":"Complacency Trap",
"-1|0|1":"Solid Harvest","-1|0|0":"Passive Drift","-1|0|-1":"Slow Bleed",
"-1|-1|1":"Latent Goldmine","-1|-1|0":"Shaky Prospect","-1|-1|-1":"Fragile Collapse"
};
const desc={
"Urgent Jackpot":"Breakthrough under fire — stable system allows urgent, high-return execution.",
"Stable Grind":"Working hard under stress, but payoff is minimal — effort keeps the system afloat.",
"Overconfident Burn":"Confidence cushions risk, but value is destroyed — strong push in the wrong direction.",
"Calculated Sprint":"Pushing fast with decent footing — risk manageable, upside strong.",
"Fire Drill":"Stressful but low-value — energy expended without major upside.",
"Stress Spiral":"Under strain, footing erodes — costs outweigh gains.",
"Chaos Bet":"Moonshot under fire — potential breakthrough, system may collapse.",
"Tenuous Push":"Forcing fragile resources into stressful, low-value territory.",
"Chaos Burn":"Explosive failure under stress — fragile and value-negative.",
"Strategic Patience":"Confident, steady progress toward high value — execute without panic.",
"Maintenance Mode":"Stable but stagnant — effort maintains, doesn’t grow.",
"Comfortable Decline":"Feels secure, but value erodes — complacency in disguise.",
"Balanced Growth":"Moderate effort, moderate footing — sustainable value creation.",
"Routine Play":"Everyday operation — safe, predictable, not transformative.",
"Stagnant Drift":"No strong risks or urgency, but slow erosion continues.",
"Fragile Moonshot":"High upside, shaky foundation — could succeed or collapse.",
"Wobbly Venture":"Unclear payoff, fragile base — outcome uncertain at best.",
"Dead End":"Fragile, no return — stuck without clear upside.",
"Calm Jackpot":"Obvious, safe win — strong footing and big upside with no rush.",
"Comfort Zone":"Safe, low-stress, but stagnant — survives without growing.",
"Complacency Trap":"Feels safe but value erodes — comfort blinds decline.",
"Solid Harvest":"Safe returns over time — not urgent, but worthwhile.",
"Passive Drift":"Minimal urgency, minimal value — just coasting.",
"Slow Bleed":"Quiet erosion over time — no stress, but value trickles away.",
"Latent Goldmine":"High potential, fragile base — increase stability before committing.",
"Shaky Prospect":"Weak stability, unclear payoff — consider re-scoping or pausing.",
"Fragile Collapse":"Fragile and negative-return — avoid or radically change conditions."
};

function sign3(x){return x>0?1:x<0?-1:0;}
function badge(el,state,pw,nw,gw){el.className="pill "+(state>0?"green":(state<0?"red":"amber"));el.textContent=state>0?pw:(state<0?gw:nw);}
function scoreTagText(n){return n>=80?"Very high energy":n>=50?"High energy":n>=25?"Moderate energy":"Low energy";}
function coachHint(ret,stab,press,urg,conf){
 const negRet=ret<=0,negStab=stab<=0,highUrg=urg>=8,lowUrg=urg<=3;
 if(negRet&&negStab)return"Value-negative and fragile — rethink or change conditions before proceeding.";
 if(negRet&&!negStab)return highUrg?"Urgent but value-negative — stop or pivot quickly; confidence won’t fix unit economics."
                                   : lowUrg?"Low urgency yet value-negative — sunset, re-price, or re-scope."
                                           :"On-schedule but value-negative — challenge the business case; pivot or prune.";
 if(!negRet&&negStab)return highUrg?"Urgent and fragile — raise confidence or reduce risk immediately before full commit."
                                   : lowUrg?"Low urgency but fragile — stabilize first to unlock the upside."
                                           :"Fragile upside — add evidence/resources or de-risk before scaling.";
 if(highUrg&&conf>=urg)return"High urgency, high confidence — execute promptly with control; align ops capacity.";
 if(highUrg&&conf<urg)return"High urgency with pressure — either raise confidence quickly or narrow scope.";
 if(lowUrg)return"Low urgency, solid profile — plan clean execution; move when it’s optimal.";
 if(press>0)return"Good profile, but pressured — confirm readiness and guard against rushed errors.";
 if(press<0)return"Survivable and value-creating — pressure is calm; proceed methodically.";
 return"Greenlight profile — execute with discipline.";
}

function compute(){
 const impact=+document.getElementById('impact').value;
 const cost=+document.getElementById('cost').value;
 const risk=+document.getElementById('risk').value;
 const urgency=+document.getElementById('urgency').value;
 const confidence=+document.getElementById('confidence').value;

 document.getElementById('o_impact').textContent=impact;
 document.getElementById('o_cost').textContent=cost;
 document.getElementById('o_risk').textContent=risk;
 document.getElementById('o_urgency').textContent=urgency;
 document.getElementById('o_confidence').textContent=confidence;

 const ret=impact-cost, stab=confidence-risk, press=urgency-confidence;
 const composite=(impact-cost-risk)+(urgency*confidence);
 const s=x=>x>0?('+'+x):(x<0?x.toString():'0');

 document.getElementById('ret').textContent=s(ret);
 document.getElementById('stab').textContent=s(stab);
 document.getElementById('press').textContent=s(press);
 document.getElementById('score').textContent=composite;
 document.getElementById('scoreTag').textContent=scoreTagText(composite);

 badge(document.getElementById('retPill'),Math.sign(ret),'Positive','Neutral','Negative');
 badge(document.getElementById('stabPill'),Math.sign(stab),'Stable','Neutral','Fragile');

 const pressPill = document.getElementById('pressPill');
 pressPill.textContent = press > 0 ? 'Pressured' : (press < 0 ? 'Calm' : 'Balanced');
 pressPill.className = 'pill ' + (press > 0 ? 'red' : (press < 0 ? 'green' : 'amber'));
 document.getElementById('press').style.color = press > 0 ? 'var(--red)' : (press < 0 ? 'var(--green)' : 'var(--amber)');

 const key=[sign3(press),sign3(stab),sign3(ret)].join('|');
 const name=names[key]||'Unclassified';
 document.getElementById('arch').textContent=name;
 document.getElementById('archDesc').textContent=desc[name]||'—';
 document.getElementById('coach').textContent=coachHint(ret,stab,press,urgency,confidence);
}

// Recompute on slider move
['impact','cost','risk','urgency','confidence'].forEach(id =>
  document.getElementById(id).addEventListener('input', compute)
);

/* —— Entry & Log logic —— */
const $ = (sel) => document.querySelector(sel);
const SLIDER_IDS = ["impact","cost","risk","urgency","confidence"];
const fmt0 = (n) => Number(n).toFixed(0);

// Simple local timestamp
function fmtLocal(ts){
  const d = new Date(ts);
  const z = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}

function readCurrent(){
  const out={};
  SLIDER_IDS.forEach(id=>out[id]=Number($('#'+id).value||0));
  return out;
}
function computeMetrics(v){
  const ret=v.impact - v.cost;
  const pressure=v.urgency - v.confidence;
  const stability=v.confidence - v.risk;
  const dnav=(v.impact - v.cost - v.risk) + (v.urgency * v.confidence);
  return {ret,pressure,stability,dnav};
}
function loadLog(){
  try{ return JSON.parse(localStorage.getItem('dnav_log_v1')||'[]'); }catch{ return []; }
}
function saveLog(arr){ localStorage.setItem('dnav_log_v1', JSON.stringify(arr)); }
function escapeHtml(s=''){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Animated Stats ---------- */
function animateNumber(el, to, {suffix='', duration=500}={}){
  const from = Number(el.dataset.val || 0);
  const start = performance.now();
  function step(t){
    const p = Math.min(1, (t - start)/duration);
    const v = Math.round(from + (to - from)*p);
    el.textContent = v + suffix;
    if(p < 1){ requestAnimationFrame(step); } else { el.dataset.val = to; }
  }
  requestAnimationFrame(step);
}
function pulse(tile){
  tile.classList.remove('pulse'); void tile.offsetWidth; tile.classList.add('pulse');
}
function filterRows(rows){
  const days = Number($('#rangeSelect').value || 0);
  if(!days) return rows;
  const cutoff = Date.now() - days*24*60*60*1000;
  return rows.filter(r=>r.ts >= cutoff);
}
function renderAlloc(rows){
  const list = $('#allocList');
  if(!rows.length){ list.innerHTML = '<div class="mini">No data in range.</div>'; return; }

  // Attention energy = Urgency × Confidence
  const totals = new Map(); // cat => {energy,count,sumD,press,stable}
  let energyAll = 0;
  rows.forEach(r=>{
    const cat=(r.category||'').trim()||'Uncategorized';
    const e = (r.urgency||0)*(r.confidence||0);
    energyAll += e;
    if(!totals.has(cat)) totals.set(cat,{energy:0,count:0,sumD:0,press:0,stable:0});
    const t=totals.get(cat);
    t.energy += e;
    t.count += 1;
    t.sumD += (Number(r.dnav)||0);
    if((r.pressure||0) > 0) t.press += 1;
    if((r.stability||0) > 0) t.stable += 1;
  });

  const rowsData = Array.from(totals.entries()).map(([cat,t])=>{
    const share = energyAll? Math.round(t.energy*100/energyAll) : 0;
    const avgD = Math.round(t.sumD / t.count);
    const pr = Math.round(t.press*100/t.count);
    const st = Math.round(t.stable*100/t.count);
    return {cat, share, avgD, count:t.count, pr, st};
  }).sort((a,b)=>b.share-a.share).slice(0,8);

  list.innerHTML = rowsData.map(r=>`
    <div class="row">
      <div><strong>${escapeHtml(r.cat)}</strong></div>
      <div class="bar"><span style="width:${r.share}%"></span></div>
      <div class="meta">${r.share}% of attention • ${r.count} decisions • avg D-NAV ${r.avgD} • stable ${r.st}% • pressured ${r.pr}%</div>
    </div>
  `).join('');
}

function renderStats(allRows){
  const rows = filterRows(allRows);
  const total = rows.length;

  const avg = total ? Math.round(rows.reduce((a,r)=>a + (Number(r.dnav)||0),0)/total) : 0;
  const posRet = total ? Math.round(rows.filter(r=>r.return>0).length*100/total) : 0;
  const pressured = total ? Math.round(rows.filter(r=>r.pressure>0).length*100/total) : 0;
  const stable = total ? Math.round(rows.filter(r=>r.stability>0).length*100/total) : 0;

  // top category
  const counts = new Map();
  rows.forEach(r=>{ const c=(r.category||'').trim(); if(!c) return; counts.set(c,(counts.get(c)||0)+1); });
  let topCat='—', topCatCount=0;
  counts.forEach((v,k)=>{ if(v>topCatCount){ topCat=k; topCatCount=v; } });

  // top archetype
  const aCounts = new Map();
  rows.forEach(r=>{
    const key=[sign3(r.pressure),sign3(r.stability),sign3(r.return)].join('|');
    const n=names[key]; if(!n) return;
    aCounts.set(n,(aCounts.get(n)||0)+1);
  });
  let topArch='—', topArchCount=0;
  aCounts.forEach((v,k)=>{ if(v>topArchCount){ topArch=k; topArchCount=v; } });

  // numbers + bars
  animateNumber($('#k_total'), total);
  $('#k_recent').textContent = `(${total} in range)`;
  animateNumber($('#k_avgdnav'), avg);
  animateNumber($('#k_posret'), posRet, {suffix:'%'});   $('#bar_posret').style.width = posRet + '%';
  animateNumber($('#k_stable'),  stable,  {suffix:'%'});   $('#bar_stable').style.width = stable + '%';
  animateNumber($('#k_pressured'), pressured, {suffix:'%'}); $('#bar_press').style.width = pressured + '%';

  pulse($('#tile_total')); pulse($('#tile_avg')); pulse($('#tile_pos')); pulse($('#tile_stable')); pulse($('#tile_press'));

  $('#k_misc').textContent = `Top category: ${topCat} • Top archetype: ${topArch}`;

  renderAlloc(rows);
}

function renderLog(){
  const rows=loadLog();
  const tbody=$('#logBody');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${new Date(r.ts).toLocaleString()}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.category||'')}</td>
      <td class="num">${fmt0(r.impact)}</td>
      <td class="num">${fmt0(r.cost)}</td>
      <td class="num">${fmt0(r.risk)}</td>
      <td class="num">${fmt0(r.urgency)}</td>
      <td class="num">${fmt0(r.confidence)}</td>
      <td class="num">${fmt0(r.return)}</td>
      <td class="num">${fmt0(r.pressure)}</td>
      <td class="num">${fmt0(r.stability)}</td>
      <td class="num" style="font-weight:700;">${fmt0(r.dnav)}</td>
      <td style="text-align:center;">
        <button data-idx="${i}" class="del" style="border:0;background:transparent;color:#fff;cursor:pointer;">✕</button>
      </td>
    </tr>
  `).join('');

  tbody.querySelectorAll('button.del').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const idx=Number(btn.getAttribute('data-idx'));
      const arr=loadLog(); arr.splice(idx,1); saveLog(arr); renderLog();
    });
  });

  renderStats(rows); // updates HUD on every render
}

function resetForm(){
  SLIDER_IDS.forEach(id=>{ const el=$('#'+id); el.value=1; });
  $('#decisionName').value='';
  $('#decisionCategory').value='';
  compute();
  $('#enterBtn').disabled = true;
}
function checkFormValid(){
  const nameOk = $('#decisionName').value.trim().length>0;
  const catOk  = $('#decisionCategory').value.trim().length>0;
  $('#enterBtn').disabled = !(nameOk && catOk);
}
function enterDecision(){
  const btn=$('#enterBtn');
  if(btn.disabled) return;
  btn.disabled = true;

  const name=$('#decisionName').value.trim();
  const category=$('#decisionCategory').value.trim();
  if(!name || !category){ btn.disabled=false; return; }

  const vals=readCurrent();
  const m=computeMetrics(vals);

  const row={
    ts:Date.now(),
    name, category,
    ...vals,
    return:m.ret, pressure:m.pressure, stability:m.stability, dnav:m.dnav
  };

  const arr=loadLog();
  arr.unshift(row);
  saveLog(arr);
  renderLog();   // triggers animated HUD refresh
  resetForm();
}

function toCsv(rows){
  const header=['timestamp_local','timestamp_iso','name','category','impact','cost','risk','urgency','confidence','return','pressure','stability','dnav'];
  const body=rows.map(r=>[
    fmtLocal(r.ts),
    new Date(r.ts).toISOString(),
    `"${(r.name||'').replace(/"/g,'""')}"`,
    `"${(r.category||'').replace(/"/g,'""')}"`,
    r.impact,r.cost,r.risk,r.urgency,r.confidence,r.return,r.pressure,r.stability,r.dnav
  ].join(','));
  return [header.join(','),...body].join('\n');
}
function downloadCsv(){
  const rows=loadLog();
  if(!rows.length){ alert('No decisions logged yet.'); return; }
  const blob=new Blob([toCsv(rows)],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='dnav_decisions.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// Listeners
$('#decisionName').addEventListener('input', checkFormValid);
$('#decisionCategory').addEventListener('input', checkFormValid);
['decisionName','decisionCategory'].forEach(id=>{
  $('#'+id).addEventListener('keydown', e => {
    if (e.key === 'Enter' && !$('#enterBtn').disabled) enterDecision();
  });
});
$('#enterBtn')?.addEventListener('click', enterDecision);
$('#downloadCsvBtn')?.addEventListener('click', downloadCsv);
$('#clearLogBtn')?.addEventListener('click', ()=>{
  if(confirm('Clear all logged decisions on this device?')){
    localStorage.removeItem('dnav_log_v1'); renderLog();
  }
});
$('#rangeSelect').addEventListener('change', ()=>renderLog());

// boot
compute();
renderLog();
checkFormValid();
</script>
</body></html>
